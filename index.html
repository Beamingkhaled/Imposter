<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Imposter Game - Arabic Version</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      background: repeating-linear-gradient(
        45deg,
        #000000,
        #000000 10px,
        #ffffff 10px,
        #ffffff 20px
      );
      min-height:100vh;
      padding:20px;
      direction: rtl;
    }
    .container{
      background:#fff;
      border:5px solid #000000;
      border-radius:15px;
      padding:25px;
      max-width:450px;
      margin:0 auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    h1{ text-align:center; color:#000000; margin-bottom:20px; }
    h2{ color:#000000; margin:15px 0; }
    input, button{ 
      width:100%; 
      padding:15px; 
      margin:10px 0; 
      font-size:18px; 
      border-radius:8px; 
      border:3px solid #000000;
      box-sizing:border-box;
      transition: all 0.3s;
    }
    button{ 
      background:#000000; 
      color:#fff; 
      cursor:pointer; 
      font-weight:bold;
      border:none;
    }
    button:hover{ transform: scale(1.02); }
    button:active{ background:#333333; }
    .btn-grey{ background:#808080; }
    .btn-grey:hover { background:#666666; }
    .hide{ display:none !important; }
    .code{ 
      font-size:70px; 
      text-align:center; 
      font-weight:900; 
      color:#000000; 
      margin:20px 0;
      letter-spacing:8px;
      text-shadow: 2px 2px 0 #ccc;
    }
    .status{ 
      color:#d00; 
      font-weight:bold; 
      margin:10px 0; 
      text-align:center;
      min-height:24px;
    }
    .success { color: #008000; }
    .roleBox{
      padding:30px;
      margin:20px 0;
      border-radius:15px;
      border:5px solid #000000;
      font-size:24px;
      font-weight:900;
      text-align:center;
      min-height:180px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
    }
    .normal{ background:#fff; color:#000000; }
    .spy{ background:#000000; color:#fff; font-size:32px; }
    .waiting{ background:#f5f5f5; color:#666; }
    .word{ 
      font-size:48px; 
      margin-top:15px; 
      color:#000000;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .players{ margin:15px 0; }
    .player{ 
      background:#f0f0f0; 
      border:2px solid #000000; 
      padding:12px; 
      margin:8px 0; 
      border-radius:8px;
      font-weight:bold;
    }
    .timer{ 
      font-size:50px; 
      font-weight:900; 
      text-align:center; 
      color:#000000; 
      margin:20px 0;
    }
    .pill{
      display:inline-block;
      padding:8px 15px;
      background:#000000;
      color:#fff;
      border-radius:20px;
      font-weight:bold;
      margin:10px 0;
    }
    input:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    #codeInput {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 5px;
    }
    .warning {
      background: #fff3cd;
      border: 2px solid #ffeaa7;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      color: #856404;
      font-size: 14px;
      text-align: center;
    }
    .arabic-word {
      font-size: 56px;
      font-weight: bold;
      margin: 20px 0;
      text-align: center;
      font-family: 'Arial', sans-serif;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø±</h1>
    <p style="text-align:center; font-size:11px; color:#666; margin-bottom:15px;">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - Ø§Ù„Ø£Ø³ÙˆØ¯ ÙˆØ§Ù„Ø£Ø¨ÙŠØ¶</p>
    
    <div id="menu">
      <button type="button" id="createBtn">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
      <button type="button" id="joinBtn" class="btn-grey">Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</button>
      <div id="menuErr" class="status"></div>
    </div>

    <div id="create" class="hide">
      <h2>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h2>
      <button type="button" id="generateBtn">ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</button>
      <button type="button" id="backFromCreate" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="createErr" class="status"></div>
    </div>

    <div id="join" class="hide">
      <h2>Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</h2>
      <input id="codeInput" type="text" maxlength="4" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…" pattern="\d*" inputmode="numeric">
      <button type="button" id="joinNowBtn">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</button>
      <button type="button" id="backFromJoin" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="joinErr" class="status"></div>
    </div>

    <div id="lobby" class="hide">
      <div class="pill">Ø§Ù„Ù…Ø¶ÙŠÙ</div>
      <h2>Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©:</h2>
      <div class="code" id="lobbyCode">0000</div>
      <div class="players">
        <div style="font-weight:bold; margin-bottom:10px;">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: <span id="pCount">0</span></div>
        <div id="pList"></div>
      </div>
      <button type="button" id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      <button type="button" id="closeBtn" class="btn-grey">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©</button>
      <div id="lobbyErr" class="status"></div>
    </div>

    <div id="waiting" class="hide">
      <div class="pill" id="waitLabel">Ù„Ø§Ø¹Ø¨</div>
      <div class="roleBox waiting">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</div>
      <div id="waitErr" class="status"></div>
    </div>

    <div id="game" class="hide">
      <div class="pill" id="gameLabel">Ù„Ø§Ø¹Ø¨</div>
      <div class="roleBox" id="role">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div class="timer" id="timer">5:00</div>
      <div id="hostBtns" class="hide">
        <button type="button" id="endBtn">Ø§Ù†Ù‡ÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        <button type="button" id="newBtn" class="btn-grey">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
      <div id="gameErr" class="status"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ========== SUPABASE CONFIGURATION ==========
    // REPLACE THESE WITH YOUR ACTUAL SUPABASE CREDENTIALS
    const SUPABASE_URL = "https://cpegnfupiqdgmqsguyed.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwZWduZnVwaXFkZ21xc2d1eWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI4NTA5ODMsImV4cCI6MjA0ODQyNjk4M30.zHRNKkZ5Lly4q4fRZQzT5iWTtq67j3JNkaf3-_W8BkI";
    
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // ========== GAME STATE ==========
    let code = null;
    let pid = null;
    let pnum = null;
    let host = false;
    let poll = null;
    let tmr = null;
    let currentWord = null;
    
    // ========== DOM ELEMENTS ==========
    const sc = {
      menu: document.getElementById("menu"),
      create: document.getElementById("create"),
      join: document.getElementById("join"),
      lobby: document.getElementById("lobby"),
      waiting: document.getElementById("waiting"),
      game: document.getElementById("game")
    };

    // ========== EVENT LISTENERS ==========
    document.getElementById("createBtn").addEventListener("click", goCreate);
    document.getElementById("joinBtn").addEventListener("click", goJoin);
    document.getElementById("generateBtn").addEventListener("click", doCreate);
    document.getElementById("joinNowBtn").addEventListener("click", doJoin);
    document.getElementById("backFromCreate").addEventListener("click", goBack);
    document.getElementById("backFromJoin").addEventListener("click", goBack);
    document.getElementById("startBtn").addEventListener("click", doStart);
    document.getElementById("closeBtn").addEventListener("click", doClose);
    document.getElementById("endBtn").addEventListener("click", doEnd);
    document.getElementById("newBtn").addEventListener("click", doNew);

    // Code input formatting
    document.getElementById("codeInput").addEventListener("input", function(e) {
      this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });

    // ========== FUNCTIONS ==========
    function hideAll() {
      Object.values(sc).forEach(s => s.classList.add("hide"));
    }

    function goCreate() {
      hideAll();
      sc.create.classList.remove("hide");
      document.getElementById("createErr").textContent = "";
    }

    function goJoin() {
      hideAll();
      sc.join.classList.remove("hide");
      document.getElementById("codeInput").focus();
      document.getElementById("joinErr").textContent = "";
    }

    function goBack() {
      if(poll) clearInterval(poll);
      hideAll();
      sc.menu.classList.remove("hide");
    }

    async function doCreate() {
      document.getElementById("createErr").textContent = "";
      
      try {
        // Generate player ID if not exists
        pid = sessionStorage.getItem("pid") || ("p_" + Date.now() + Math.random().toString(36).substr(2, 9));
        sessionStorage.setItem("pid", pid);

        // Generate 4-digit code
        code = String(Math.floor(1000 + Math.random() * 9000));
        
        console.log("Creating room with code:", code);

        // First, create the necessary tables if they don't exist
        await createTablesIfNeeded();

        // Create room in Supabase
        const {error: re} = await sb.from("rooms").insert([{
          code: code,
          status: "open",
          state: "waiting",
          host_player_id: pid,
          created_at: new Date().toISOString()
        }]);
        
        if(re) {
          console.error("Room creation error:", re);
          // If error is about table not existing, create it
          if (re.message.includes("relation") && re.message.includes("does not exist")) {
            await createTablesIfNeeded();
            // Try again
            const {error: re2} = await sb.from("rooms").insert([{
              code: code,
              status: "open",
              state: "waiting",
              host_player_id: pid,
              created_at: new Date().toISOString()
            }]);
            if (re2) throw re2;
          } else {
            throw re;
          }
        }

        // Add host as player 1
        const {error: pe} = await sb.from("players").insert([{
          room_code: code,
          player_id: pid,
          player_num: 1,
          joined_at: new Date().toISOString()
        }]);
        
        if(pe) throw pe;

        pnum = 1;
        host = true;
        sessionStorage.setItem("code", code);
        sessionStorage.setItem("pnum", "1");
        sessionStorage.setItem("host", "1");

        document.getElementById("lobbyCode").textContent = code;
        hideAll();
        sc.lobby.classList.remove("hide");
        doPoll();

      } catch(e) {
        console.error("Create error:", e);
        document.getElementById("createErr").textContent = e.message || "ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©";
      }
    }

    async function doJoin() {
      document.getElementById("joinErr").textContent = "";
      
      try {
        code = document.getElementById("codeInput").value.trim();
        
        if(!/^\d{4}$/.test(code)) {
          document.getElementById("joinErr").textContent = "Ø£Ø¯Ø®Ù„ 4 Ø£Ø±Ù‚Ø§Ù…";
          return;
        }

        console.log("Joining room:", code);

        // Generate player ID if not exists
        pid = sessionStorage.getItem("pid") || ("p_" + Date.now() + Math.random().toString(36).substr(2, 9));
        sessionStorage.setItem("pid", pid);

        // Check if room exists and is open
        const {data: rm, error: re} = await sb.from("rooms")
          .select("*")
          .eq("code", code)
          .maybeSingle();
          
        if(re) throw re;
        
        if(!rm) {
          document.getElementById("joinErr").textContent = "Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©";
          return;
        }
        
        if(rm.status !== "open") {
          document.getElementById("joinErr").textContent = "Ø§Ù„ØºØ±ÙØ© Ù…ØºÙ„Ù‚Ø©";
          return;
        }

        // Check if player already exists in this room
        const {data: ex} = await sb.from("players")
          .select("player_num")
          .eq("room_code", code)
          .eq("player_id", pid)
          .maybeSingle();

        if(ex) {
          pnum = ex.player_num;
          console.log("Existing player, number:", pnum);
        } else {
          // Get all players to determine next number
          const {data: pls} = await sb.from("players")
            .select("player_num")
            .eq("room_code", code);
            
          const used = new Set((pls || []).map(p => p.player_num));
          let n = 1;
          while(used.has(n)) n++;

          // Add new player
          const {error: ae} = await sb.from("players").insert([{
            room_code: code,
            player_id: pid,
            player_num: n,
            joined_at: new Date().toISOString()
          }]);
          
          if(ae) throw ae;
          pnum = n;
          console.log("New player, number:", pnum);
        }

        host = false;
        sessionStorage.setItem("code", code);
        sessionStorage.setItem("pnum", String(pnum));
        sessionStorage.setItem("host", "0");

        document.getElementById("waitLabel").textContent = "Ù„Ø§Ø¹Ø¨ " + pnum;
        hideAll();
        sc.waiting.classList.remove("hide");
        doPoll();

      } catch(e) {
        console.error("Join error:", e);
        document.getElementById("joinErr").textContent = e.message || "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©";
      }
    }

    async function doStart() {
      document.getElementById("lobbyErr").textContent = "";
      
      try {
        // Get all players
        const {data: pls} = await sb.from("players")
          .select("player_id")
          .eq("room_code", code);
          
        if(!pls || pls.length < 2) {
          document.getElementById("lobbyErr").textContent = "ÙŠØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 2";
          return;
        }

        console.log("Starting game with players:", pls.length);

        // Get random Arabic word from your Supabase table
        const {data: wds, error: wdErr} = await sb.from("words").select("text");
        
        if(wdErr) throw wdErr;
        if(!wds || wds.length === 0) {
          document.getElementById("lobbyErr").textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù…ØªØ§Ø­Ø©";
          return;
        }
        
        const wordData = wds[Math.floor(Math.random() * wds.length)];
        currentWord = wordData.text;
        console.log("Selected Arabic word:", currentWord);

        // Determine number of imposters based on player count
        const playerCount = pls.length;
        const imposterCount = playerCount >= 5 ? 2 : 1;
        console.log(`Players: ${playerCount}, Imposters: ${imposterCount}`);

        // Shuffle players and select imposters
        const shuffledPlayers = [...pls].sort(() => Math.random() - 0.5);
        const imposters = shuffledPlayers.slice(0, imposterCount).map(p => p.player_id);
        
        console.log("Imposters selected:", imposters);

        // Update room state
        const {error: ue} = await sb.from("rooms").update({
          state: "playing",
          word: currentWord,
          spy_player_id: imposters[0],
          imposters: imposters,
          started_at: new Date().toISOString()
        }).eq("code", code);
        
        if(ue) throw ue;

        console.log("Game started successfully");

      } catch(e) {
        console.error("Start error:", e);
        document.getElementById("lobbyErr").textContent = e.message || "ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©";
      }
    }

    async function doEnd() {
      if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©ØŸ")) return;
      
      try {
        await sb.from("rooms").update({state: "ended"}).eq("code", code);
        console.log("Round ended");
      } catch(e) {
        console.error("End round error:", e);
      }
    }

    async function doNew() {
      if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ")) return;
      
      try {
        await sb.from("rooms").update({
          state: "waiting",
          word: null,
          spy_player_id: null,
          imposters: null,
          started_at: null
        }).eq("code", code);
        
        console.log("New round started");
        
        // Update local display
        hideAll();
        sc.lobby.classList.remove("hide");
        document.getElementById("lobbyErr").textContent = "Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©...";
        document.getElementById("lobbyErr").className = "status success";
        
      } catch(e) {
        console.error("New round error:", e);
      }
    }

    async function doClose() {
      if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©ØŸ Ø³ÙŠØªÙ… ÙØµÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.")) return;
      
      try {
        await sb.from("rooms").update({status: "closed"}).eq("code", code);
        await sb.from("players").delete().eq("room_code", code);
        
        if(poll) clearInterval(poll);
        goBack();
      } catch(e) {
        console.error("Close room error:", e);
      }
    }

    async function createTablesIfNeeded() {
      try {
        // Check if rooms table exists
        const { error: roomsError } = await sb.from('rooms').select('*').limit(1);
        
        if (roomsError && roomsError.message.includes("does not exist")) {
          console.log("Creating tables...");
          
          // Run SQL to create tables (you need to run this in Supabase SQL Editor)
          // Since we can't run DDL from client, we'll show instructions
          const needsSetup = !sessionStorage.getItem('tables_created_notice');
          
          if (needsSetup) {
            alert("âš ï¸ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Supabase Ø£ÙˆÙ„Ø§Ù‹.\n\nØ§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ SQL Editor ÙÙŠ Supabase ÙˆØ£Ø´ØºÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯:\n\n" + getSetupSQL());
            sessionStorage.setItem('tables_created_notice', 'true');
          }
        }
      } catch (e) {
        console.error("Table check error:", e);
      }
    }

    function getSetupSQL() {
      return `-- Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØºØ±Ù
CREATE TABLE IF NOT EXISTS rooms (
  code TEXT PRIMARY KEY,
  status TEXT DEFAULT 'open',
  state TEXT DEFAULT 'waiting',
  word TEXT,
  spy_player_id TEXT,
  imposters TEXT[],
  host_player_id TEXT,
  started_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
CREATE TABLE IF NOT EXISTS players (
  id BIGSERIAL PRIMARY KEY,
  room_code TEXT REFERENCES rooms(code) ON DELETE CASCADE,
  player_id TEXT NOT NULL,
  player_num INTEGER NOT NULL,
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(room_code, player_id),
  UNIQUE(room_code, player_num)
);

-- ØªÙ…ÙƒÙŠÙ† Ø£Ù…Ø§Ù† Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙÙˆÙ
ALTER TABLE rooms ENABLE ROW LEVEL SECURITY;
ALTER TABLE players ENABLE ROW LEVEL SECURITY;

-- Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ØºØ±Ù
CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø±Ø¤ÙŠØ© Ø§Ù„ØºØ±Ù" ON rooms
  FOR SELECT USING (true);

CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ø¶Ø§ÙØ© ØºØ±Ù" ON rooms
  FOR INSERT WITH CHECK (true);

CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±Ù" ON rooms
  FOR UPDATE USING (true);

-- Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø±Ø¤ÙŠØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†" ON players
  FOR SELECT USING (true);

CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ÙŠÙ†" ON players
  FOR INSERT WITH CHECK (true);

CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†" ON players
  FOR DELETE USING (true);

-- Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø§Ø±Ø³ Ù„Ù„Ø£Ø¯Ø§Ø¡
CREATE INDEX IF NOT EXISTS idx_rooms_code ON rooms(code);
CREATE INDEX IF NOT EXISTS idx_players_room_code ON players(room_code);`;
    }

    function doPoll() {
      if(poll) clearInterval(poll);
      
      poll = setInterval(async () => {
        try {
          if(!code) return;
          
          const {data: rm, error: re} = await sb.from("rooms")
            .select("*")
            .eq("code", code)
            .maybeSingle();
            
          if(re) throw re;
          
          if(!rm || rm.status !== "open") {
            if(poll) clearInterval(poll);
            alert("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©");
            goBack();
            return;
          }

          // Update lobby if host
          if(host && rm.state === "waiting") {
            const {data: pls} = await sb.from("players")
              .select("player_num, player_id")
              .eq("room_code", code)
              .order("player_num");
              
            if(pls) {
              document.getElementById("pCount").textContent = pls.length;
              document.getElementById("pList").innerHTML = pls
                .map(p => `<div class="player">Ù„Ø§Ø¹Ø¨ ${p.player_num}${p.player_id === pid ? ' (Ø£Ù†Øª - Ø§Ù„Ù…Ø¶ÙŠÙ)' : ''}</div>`)
                .join("");
            }
          }

          // Handle game state changes
          if(rm.state === "playing" && rm.started_at) {
            showGame(rm);
          } else if(rm.state === "ended") {
            if(host) {
              hideAll();
              sc.lobby.classList.remove("hide");
              document.getElementById("lobbyErr").textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ 'Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©' Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
              document.getElementById("lobbyErr").className = "status";
            } else {
              hideAll();
              sc.waiting.classList.remove("hide");
              document.getElementById("waitErr").textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...";
            }
          }

        } catch(e) {
          console.error("Poll error:", e);
        }
      }, 2000);
    }

    function showGame(rm) {
      hideAll();
      sc.game.classList.remove("hide");

      const imps = rm.imposters || (rm.spy_player_id ? [rm.spy_player_id] : []);
      const isImp = imps.includes(pid);

      document.getElementById("gameLabel").textContent = "Ù„Ø§Ø¹Ø¨ " + pnum;
      const rb = document.getElementById("role");

      if(isImp) {
        rb.className = "roleBox spy";
        rb.innerHTML = "ğŸ•µï¸<br><br>Ø£Ù†Øª Ø§Ù„Ù…Ø®Ø¨Ø±<br><br>ğŸ­";
      } else {
        rb.className = "roleBox normal";
        rb.innerHTML = `Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ© Ù‡ÙŠ:<div class="word arabic-word">${escapeHtml(rm.word || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ")}</div>`;
      }

      // Show host buttons if host
      if(host) {
        document.getElementById("hostBtns").classList.remove("hide");
      }

      // Start timer
      const start = new Date(rm.started_at).getTime();
      if(tmr) clearInterval(tmr);
      
      tmr = setInterval(() => {
        const elapsed = Math.floor((Date.now() - start) / 1000);
        const remaining = Math.max(0, 300 - elapsed); // 5 minutes
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        
        document.getElementById("timer").textContent = remaining > 0
          ? `${minutes}:${String(seconds).padStart(2, "0")}`
          : "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª â°";
      }, 1000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== INITIALIZE ==========
    window.addEventListener("load", async () => {
      // Test Supabase connection
      try {
        const { data, error } = await sb.from('words').select('text').limit(1);
        
        if (error) {
          console.error("Supabase connection error:", error);
          document.getElementById("menu").insertAdjacentHTML('afterbegin', 
            '<div class="warning">âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…ÙØªØ§Ø­ API.</div>'
          );
        } else {
          console.log("Connected to Supabase successfully. Words available:", data ? data.length : 0);
        }
      } catch (e) {
        console.error("Initial connection test failed:", e);
      }
      
      const c = sessionStorage.getItem("code");
      const n = sessionStorage.getItem("pnum");
      const p = sessionStorage.getItem("pid");
      const h = sessionStorage.getItem("host") === "1";

      if(c && n && p) {
        code = c;
        pnum = parseInt(n);
        pid = p;
        host = h;

        console.log("Restored session:", { code, pnum, pid, host });

        if(host) {
          document.getElementById("lobbyCode").textContent = code;
          hideAll();
          sc.lobby.classList.remove("hide");
        } else {
          document.getElementById("waitLabel").textContent = "Ù„Ø§Ø¹Ø¨ " + pnum;
          hideAll();
          sc.waiting.classList.remove("hide");
        }
        doPoll();
      }
    });

    window.addEventListener("beforeunload", () => {
      if(poll) clearInterval(poll);
      if(tmr) clearInterval(tmr);
    });
  </script>
</body>
</html>
