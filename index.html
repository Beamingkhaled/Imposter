<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>ŸÑÿπÿ®ÿ© ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ üïµÔ∏è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 20px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
        }
        button {
            width: 100%;
            padding: 18px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #5568d3; }
        .role-display {
            text-align: center;
            margin-top: 30px;
            padding: 30px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .role-normal {
            background: #d4edda;
            color: #155724;
            border: 3px solid #28a745;
        }
        .role-spy {
            background: #f8d7da;
            color: #721c24;
            border: 3px solid #dc3545;
            font-size: 32px;
        }
        .word { font-size: 36px; color: #28a745; margin-top: 15px; }
        .timer {
            text-align: center;
            font-size: 42px;
            color: #764ba2;
            margin-top: 20px;
            font-weight: bold;
        }
        .player-label {
            text-align: center;
            font-size: 20px;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .hidden { display: none; }
        .status {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üïµÔ∏è ŸÑÿπÿ®ÿ© ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥</h1>
        
        <div id="joinScreen">
            <label>ÿ±ŸÖÿ≤ ÿßŸÑÿ∫ÿ±ŸÅÿ©</label>
            <input type="tel" id="roomCode" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÖÿ≤" maxlength="6">
            <button onclick="joinRoom()">ÿßŸÜÿ∂ŸÖÿßŸÖ</button>
            <div class="status" id="status"></div>
        </div>

        <div id="gameScreen" class="hidden">
            <div class="player-label" id="playerLabel"></div>
            <div class="role-display" id="roleDisplay">‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿØÿ° ÿßŸÑÿ¨ŸàŸÑÿ©...</div>
            <div class="timer" id="timer"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'spy_game_';
        let roomCode, playerId, playerNum;
        let pollTimer, timerInterval;

        function joinRoom() {
            roomCode = document.getElementById('roomCode').value.trim();
            if (!roomCode || !/^\d+$/.test(roomCode)) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÖÿ≤ ÿµÿ≠Ÿäÿ≠ (ÿ£ÿ±ŸÇÿßŸÖ ŸÅŸÇÿ∑)');
                return;
            }

            playerId = localStorage.getItem('playerId') || 'p_' + Date.now() + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('playerId', playerId);

            let room = getRoom();
            if (!room) {
                document.getElementById('status').textContent = 'ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©';
                return;
            }

            if (!room.players.find(p => p.id === playerId)) {
                playerNum = room.players.length + 1;
                room.players.push({ id: playerId, num: playerNum });
                saveRoom(room);
            } else {
                playerNum = room.players.find(p => p.id === playerId).num;
            }

            sessionStorage.setItem('roomCode', roomCode);
            sessionStorage.setItem('playerNum', playerNum);

            showGameScreen();
            startPolling();
        }

        function showGameScreen() {
            document.getElementById('joinScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('playerLabel').textContent = `ÿ£ŸÜÿ™: ŸÑÿßÿπÿ® ${toArabic(playerNum)}`;
        }

        function startPolling() {
            pollTimer = setInterval(() => {
                let room = getRoom();
                if (!room) return;

                if (room.state === 'playing' && room.round) {
                    showRole(room.round);
                } else {
                    document.getElementById('roleDisplay').innerHTML = '‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿØÿ° ÿßŸÑÿ¨ŸàŸÑÿ©...';
                    document.getElementById('roleDisplay').className = 'role-display';
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        document.getElementById('timer').textContent = '';
                    }
                }
            }, 1500);
        }

        function showRole(round) {
            const display = document.getElementById('roleDisplay');
            if (round.spyId === playerId) {
                display.innerHTML = 'üïµÔ∏è<br>ÿ£ŸÜÿ™ ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥';
                display.className = 'role-display role-spy';
            } else {
                display.innerHTML = `ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±Ÿäÿ©:<div class="word">${round.word}</div>`;
                display.className = 'role-display role-normal';
            }

            if (round.startTime && !timerInterval) {
                startTimer(round.startTime);
            }
        }

        function startTimer(startTime) {
            const duration = 5 * 60;
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const remaining = Math.max(0, duration - elapsed);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                document.getElementById('timer').textContent = 
                    remaining > 0 ? `${toArabic(mins)}:${toArabic(secs.toString().padStart(2, '0'))}` : '‚è∞ ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™';
            }, 1000);
        }

        function getRoom() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY + roomCode));
        }

        function saveRoom(room) {
            localStorage.setItem(STORAGE_KEY + roomCode, JSON.stringify(room));
        }

        function toArabic(num) {
            const ar = ['Ÿ†','Ÿ°','Ÿ¢','Ÿ£','Ÿ§','Ÿ•','Ÿ¶','Ÿß','Ÿ®','Ÿ©'];
            return num.toString().split('').map(d => ar[d] || d).join('');
        }

        window.onload = () => {
            roomCode = sessionStorage.getItem('roomCode');
            playerNum = sessionStorage.getItem('playerNum');
            playerId = localStorage.getItem('playerId');
            if (roomCode && playerNum) {
                showGameScreen();
                startPolling();
            }
        };
    </script>
</body>
</html>
