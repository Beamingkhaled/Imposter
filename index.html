<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Imposter Game</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      background: repeating-linear-gradient(
        45deg,
        #6B46C1,
        #6B46C1 10px,
        #808080 10px,
        #808080 20px
      );
      min-height:100vh;
      padding:20px;
    }
    .container{
      background:#fff;
      border:5px solid #6B46C1;
      border-radius:15px;
      padding:25px;
      max-width:450px;
      margin:0 auto;
    }
    h1{ text-align:center; color:#6B46C1; margin-bottom:20px; }
    h2{ color:#6B46C1; margin:15px 0; }
    input, button{ 
      width:100%; 
      padding:15px; 
      margin:10px 0; 
      font-size:18px; 
      border-radius:8px; 
      border:3px solid #6B46C1;
      box-sizing:border-box;
    }
    button{ 
      background:#6B46C1; 
      color:#fff; 
      cursor:pointer; 
      font-weight:bold;
      border:none;
    }
    button:active{ background:#553399; }
    .btn-grey{ background:#808080; }
    .btn-grey:active{ background:#666; }
    .hide{ display:none; }
    .code{ 
      font-size:70px; 
      text-align:center; 
      font-weight:900; 
      color:#6B46C1; 
      margin:20px 0;
      letter-spacing:8px;
    }
    .status{ color:#d00; font-weight:bold; margin:10px 0; text-align:center; }
    .roleBox{
      padding:30px;
      margin:20px 0;
      border-radius:15px;
      border:5px solid #6B46C1;
      font-size:24px;
      font-weight:900;
      text-align:center;
      min-height:180px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
    }
    .normal{ background:#fff; color:#6B46C1; }
    .spy{ background:#6B46C1; color:#fff; font-size:32px; }
    .waiting{ background:#f5f5f5; color:#666; }
    .word{ font-size:48px; margin-top:15px; color:#6B46C1; }
    .players{ margin:15px 0; }
    .player{ 
      background:#f0f0f0; 
      border:2px solid #6B46C1; 
      padding:12px; 
      margin:8px 0; 
      border-radius:8px;
      font-weight:bold;
    }
    .timer{ 
      font-size:50px; 
      font-weight:900; 
      text-align:center; 
      color:#6B46C1; 
      margin:20px 0;
    }
    .pill{
      display:inline-block;
      padding:8px 15px;
      background:#6B46C1;
      color:#fff;
      border-radius:20px;
      font-weight:bold;
      margin:10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üïµÔ∏è IMPOSTER GAME</h1>
    <p style="text-align:center; font-size:11px; color:#666; margin-bottom:15px;">GREY & PURPLE VERSION</p>

    <div id="menu">
      <button type="button" onclick="goCreate()">CREATE ROOM</button>
      <button type="button" onclick="goJoin()" class="btn-grey">JOIN ROOM</button>
      <div id="menuErr" class="status"></div>
    </div>

    <div id="create" class="hide">
      <h2>Create Room</h2>
      <button type="button" onclick="doCreate()">GENERATE CODE</button>
      <button type="button" onclick="goBack()" class="btn-grey">Back</button>
      <div id="createErr" class="status"></div>
    </div>

    <div id="join" class="hide">
      <h2>Join Room</h2>
      <input id="codeInput" type="text" maxlength="4" placeholder="Enter 4-digit code">
      <button type="button" onclick="doJoin()">JOIN NOW</button>
      <button type="button" onclick="goBack()" class="btn-grey">Back</button>
      <div id="joinErr" class="status"></div>
    </div>

    <div id="lobby" class="hide">
      <div class="pill">HOST</div>
      <h2>Room Code:</h2>
      <div class="code" id="lobbyCode">0000</div>
      <div class="players">
        <div style="font-weight:bold; margin-bottom:10px;">Players: <span id="pCount">0</span></div>
        <div id="pList"></div>
      </div>
      <button type="button" onclick="doStart()">START GAME</button>
      <button type="button" onclick="doClose()" class="btn-grey">CLOSE ROOM</button>
      <div id="lobbyErr" class="status"></div>
    </div>

    <div id="waiting" class="hide">
      <div class="pill" id="waitLabel">Player</div>
      <div class="roleBox waiting">Waiting for host to start...</div>
      <div id="waitErr" class="status"></div>
    </div>

    <div id="game" class="hide">
      <div class="pill" id="gameLabel">Player</div>
      <div class="roleBox" id="role">Loading...</div>
      <div class="timer" id="timer"></div>
      <div id="hostBtns" class="hide">
        <button type="button" onclick="doEnd()">END ROUND</button>
        <button type="button" onclick="doNew()" class="btn-grey">NEW ROUND</button>
      </div>
      <div id="gameErr" class="status"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const sb = window.supabase.createClient(
      "https://cpegnfupiqdgmqsguyed.supabase.co",
      "sb_publishable_WKaLUCc9WeXbEcgDfMf1KQ_NKYoTVuU"
    );

    let code = null;
    let pid = null;
    let pnum = null;
    let host = false;
    let poll = null;
    let tmr = null;

    const sc = {
      menu: document.getElementById("menu"),
      create: document.getElementById("create"),
      join: document.getElementById("join"),
      lobby: document.getElementById("lobby"),
      waiting: document.getElementById("waiting"),
      game: document.getElementById("game")
    };

    function hideAll() {
      Object.values(sc).forEach(s => s.className = "hide");
    }

    function goCreate() {
      hideAll();
      sc.create.className = "";
    }

    function goJoin() {
      hideAll();
      sc.join.className = "";
    }

    function goBack() {
      if(poll) clearInterval(poll);
      hideAll();
      sc.menu.className = "";
    }

    async function doCreate() {
      document.getElementById("createErr").textContent = "";
      try {
        pid = ss("pid") || ("p_" + rand());
        ss("pid", pid);

        code = String(Math.floor(1000 + Math.random() * 9000));

        const {error:re} = await sb.from("rooms").insert([{
          code: code,
          status: "open",
          state: "waiting",
          host_player_id: pid
        }]);
        if(re) throw re;

        const {error:pe} = await sb.from("players").insert([{
          room_code: code,
          player_id: pid,
          player_num: 1
        }]);
        if(pe) throw pe;

        pnum = 1;
        host = true;
        ss("code", code);
        ss("pnum", "1");
        ss("host", "1");

        document.getElementById("lobbyCode").textContent = code;
        hideAll();
        sc.lobby.className = "";
        doPoll();

      } catch(e) {
        document.getElementById("createErr").textContent = e.message;
      }
    }

    async function doJoin() {
      document.getElementById("joinErr").textContent = "";
      try {
        code = document.getElementById("codeInput").value.trim();
        if(!/^\d{4}$/.test(code)) {
          document.getElementById("joinErr").textContent = "Enter 4 digits";
          return;
        }

        pid = ss("pid") || ("p_" + rand());
        ss("pid", pid);

        const {data:rm, error:re} = await sb.from("rooms")
          .select("*").eq("code", code).maybeSingle();
        if(re) throw re;
        if(!rm) {
          document.getElementById("joinErr").textContent = "Room not found";
          return;
        }
        if(rm.status !== "open") {
          document.getElementById("joinErr").textContent = "Room closed";
          return;
        }

        const {data:ex} = await sb.from("players")
          .select("player_num").eq("room_code", code).eq("player_id", pid).maybeSingle();

        if(ex) {
          pnum = ex.player_num;
        } else {
          const {data:pls} = await sb.from("players")
            .select("player_num").eq("room_code", code);
          const used = new Set((pls||[]).map(p => p.player_num));
          let n = 1;
          while(used.has(n)) n++;

          const {error:ae} = await sb.from("players").insert([{
            room_code: code,
            player_id: pid,
            player_num: n
          }]);
          if(ae) throw ae;
          pnum = n;
        }

        host = false;
        ss("code", code);
        ss("pnum", String(pnum));
        ss("host", "0");

        document.getElementById("waitLabel").textContent = "Player " + pnum;
        hideAll();
        sc.waiting.className = "";
        doPoll();

      } catch(e) {
        document.getElementById("joinErr").textContent = e.message;
      }
    }

    async function doStart() {
      document.getElementById("lobbyErr").textContent = "";
      try {
        const {data:pls} = await sb.from("players").select("player_id").eq("room_code", code);
        if(!pls || pls.length < 2) {
          document.getElementById("lobbyErr").textContent = "Need 2+ players";
          return;
        }

        const {data:wds} = await sb.from("words").select("text");
        if(!wds || wds.length === 0) throw new Error("No words");
        const word = wds[Math.floor(Math.random() * wds.length)].text;

        const impCnt = pls.length >= 5 ? 2 : 1;
        const sh = [...pls].sort(() => Math.random() - 0.5);
        const imps = sh.slice(0, impCnt).map(p => p.player_id);

        await sb.from("rooms").update({
          state: "playing",
          word: word,
          spy_player_id: imps[0],
          imposters: imps,
          started_at: new Date().toISOString()
        }).eq("code", code);

      } catch(e) {
        document.getElementById("lobbyErr").textContent = e.message;
      }
    }

    async function doEnd() {
      if(!confirm("End round?")) return;
      await sb.from("rooms").update({state:"ended"}).eq("code", code);
    }

    async function doNew() {
      if(!confirm("New round?")) return;
      await sb.from("rooms").update({
        state:"waiting",
        word:null,
        spy_player_id:null,
        imposters:null,
        started_at:null
      }).eq("code", code);
    }

    async function doClose() {
      if(!confirm("Close room?")) return;
      await sb.from("rooms").update({status:"closed"}).eq("code", code);
      await sb.from("players").delete().eq("room_code", code);
      if(poll) clearInterval(poll);
      goBack();
    }

    function doPoll() {
      if(poll) clearInterval(poll);
      poll = setInterval(async () => {
        try {
          const {data:rm} = await sb.from("rooms").select("*").eq("code", code).maybeSingle();
          if(!rm || rm.status !== "open") {
            if(poll) clearInterval(poll);
            alert("Room closed");
            goBack();
            return;
          }

          if(host && rm.state === "waiting") {
            const {data:pls} = await sb.from("players")
              .select("player_num, player_id").eq("room_code", code).order("player_num");
            document.getElementById("pCount").textContent = pls.length;
            document.getElementById("pList").innerHTML = pls
              .map(p => `<div class="player">Player ${p.player_num}${p.player_id===pid?' (YOU)':''}</div>`)
              .join("");
          }

          if(rm.state === "playing" && rm.started_at) {
            showGame(rm);
          }

          if(rm.state === "ended") {
            if(host) {
              hideAll();
              sc.lobby.className = "";
              document.getElementById("lobbyErr").textContent = "Round ended";
            } else {
              hideAll();
              sc.waiting.className = "";
              document.getElementById("waitErr").textContent = "Round ended. Waiting...";
            }
          }

        } catch(e) {
          console.error(e);
        }
      }, 1500);
    }

    function showGame(rm) {
      hideAll();
      sc.game.className = "";

      const imps = rm.imposters || [rm.spy_player_id];
      const isImp = imps.includes(pid);

      document.getElementById("gameLabel").textContent = "Player " + pnum;
      const rb = document.getElementById("role");

      if(isImp) {
        rb.className = "roleBox spy";
        rb.innerHTML = "üïµÔ∏è YOU ARE THE IMPOSTER";
      } else {
        rb.className = "roleBox normal";
        rb.innerHTML = `SECRET WORD:<div class="word">${esc(rm.word)}</div>`;
      }

      if(host) {
        document.getElementById("hostBtns").className = "";
      }

      const start = new Date(rm.started_at).getTime();
      if(tmr) clearInterval(tmr);
      tmr = setInterval(() => {
        const el = Math.floor((Date.now() - start) / 1000);
        const rem = Math.max(0, 300 - el);
        const m = Math.floor(rem / 60);
        const s = rem % 60;
        document.getElementById("timer").textContent = rem > 0
          ? `${m}:${String(s).padStart(2,"0")}`
          : "TIME UP ‚è∞";
      }, 500);
    }

    function ss(k, v) {
      if(v === undefined) return sessionStorage.getItem(k);
      sessionStorage.setItem(k, v);
    }

    function rand() {
      const a = new Uint8Array(16);
      crypto.getRandomValues(a);
      return Array.from(a).map(b => b.toString(16).padStart(2,"0")).join("");
    }

    function esc(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    window.addEventListener("load", () => {
      const c = ss("code");
      const n = ss("pnum");
      const p = ss("pid");
      const h = ss("host") === "1";

      if(c && n && p) {
        code = c;
        pnum = parseInt(n);
        pid = p;
        host = h;

        if(host) {
          document.getElementById("lobbyCode").textContent = code;
          hideAll();
          sc.lobby.className = "";
        } else {
          document.getElementById("waitLabel").textContent = "Player " + pnum;
          hideAll();
          sc.waiting.className = "";
        }
        doPoll();
      }
    });

    window.addEventListener("beforeunload", () => {
      if(poll) clearInterval(poll);
      if(tmr) clearInterval(tmr);
    });
  </script>
</body>
</html>
