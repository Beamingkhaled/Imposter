<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø± - ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†!</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Arial, sans-serif;
      background: repeating-linear-gradient(45deg, #22c55e, #22c55e 10px, #ffffff 10px, #ffffff 20px);
      min-height:100vh;
      padding:20px;
      direction: rtl;
    }
    .container {
      background:#fff;
      border:5px solid #22c55e;
      border-radius:15px;
      padding:25px;
      max-width:450px;
      margin:0 auto;
    }
    h1 { text-align:center; color:#22c55e; margin-bottom:20px; }
    button {
      width:100%;
      padding:15px;
      margin:10px 0;
      font-size:18px;
      border-radius:8px;
      border:none;
      background:#22c55e;
      color:white;
      cursor:pointer;
      font-weight:bold;
    }
    button:hover { opacity:0.9; }
    .btn-grey { background:#666; }
    .hide { display:none; }
    .code {
      font-size:80px;
      text-align:center;
      font-weight:900;
      color:#22c55e;
      margin:20px 0;
      letter-spacing:10px;
    }
    .status {
      color:red;
      text-align:center;
      margin:10px 0;
      min-height:20px;
    }
    input {
      width:100%;
      padding:15px;
      font-size:24px;
      text-align:center;
      border:3px solid #22c55e;
      border-radius:8px;
      margin:10px 0;
    }
    .roleBox {
      padding:20px;
      margin:20px 0;
      border:5px solid #22c55e;
      border-radius:15px;
      text-align:center;
      font-size:24px;
      min-height:150px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .spy {
      background:#22c55e;
      color:white;
    }
    .word {
      font-size:48px;
      color:#22c55e;
      margin-top:10px;
    }
    .player {
      background:#f0f0f0;
      padding:10px;
      margin:5px 0;
      border-radius:8px;
      border:2px solid #22c55e;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø±</h1>
    
    <!-- MENU -->
    <div id="menu">
      <button onclick="showCreate()">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
      <button onclick="showJoin()" class="btn-grey">Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</button>
    </div>
    
    <!-- CREATE -->
    <div id="create" class="hide">
      <h2>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
      <button onclick="createRoom()">ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</button>
      <button onclick="goBack()" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="createErr" class="status"></div>
    </div>
    
    <!-- JOIN -->
    <div id="join" class="hide">
      <h2>Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</h2>
      <input id="roomCode" type="text" maxlength="4" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²">
      <button onclick="joinRoom()">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</button>
      <button onclick="goBack()" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="joinErr" class="status"></div>
    </div>
    
    <!-- LOBBY -->
    <div id="lobby" class="hide">
      <h2>ğŸ‘‘ Ø£Ù†Øª Ø§Ù„Ù…Ø¶ÙŠÙ</h2>
      <div class="code" id="roomCodeDisplay">0000</div>
      <div id="playersList"></div>
      <button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      <button onclick="leaveRoom()" class="btn-grey">ØªØ±Ùƒ Ø§Ù„ØºØ±ÙØ©</button>
    </div>
    
    <!-- WAITING -->
    <div id="waiting" class="hide">
      <h2>ğŸ‘¥ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ</h2>
      <div class="roleBox">
        Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...
        <div id="playerCount">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: 1</div>
      </div>
      <button onclick="leaveRoom()" class="btn-grey">ØªØ±Ùƒ Ø§Ù„ØºØ±ÙØ©</button>
    </div>
    
    <!-- GAME -->
    <div id="game" class="hide">
      <h2 id="playerTitle">Ù„Ø§Ø¹Ø¨</h2>
      <div class="roleBox" id="roleBox">
        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
      </div>
      <div id="hostControls" class="hide">
        <button onclick="endGame()">Ø§Ù†Ù‡ÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        <button onclick="newGame()" class="btn-grey">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
      <button onclick="leaveRoom()" class="btn-grey">ØªØ±Ùƒ Ø§Ù„ØºØ±ÙØ©</button>
    </div>
  </div>

  <script>
    // SIMPLE GAME STATE
    let roomCode = '';
    let playerId = '';
    let isHost = false;
    let currentPlayers = [];
    
    // SUPABASE CONFIG
    const SUPABASE_URL = 'https://cpegnfupiqdgmqsguyed.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwZWduZnVwaXFkZ21xc2d1eWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI4NTA5ODMsImV4cCI6MjA0ODQyNjk4M30.zHRNKkZ5Lly4q4fRZQzT5iWTtq67j3JNkaf3-_W8BkI';
    
    // LOAD SUPABASE
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
    document.head.appendChild(script);
    
    script.onload = function() {
      window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      console.log('Supabase loaded');
    };
    
    // SIMPLE FUNCTIONS
    function showCreate() {
      hideAll();
      document.getElementById('create').classList.remove('hide');
    }
    
    function showJoin() {
      hideAll();
      document.getElementById('join').classList.remove('hide');
      document.getElementById('roomCode').focus();
    }
    
    function goBack() {
      hideAll();
      document.getElementById('menu').classList.remove('hide');
    }
    
    function hideAll() {
      ['menu','create','join','lobby','waiting','game'].forEach(id => {
        document.getElementById(id).classList.add('hide');
      });
    }
    
    // CREATE ROOM - WORKING!
    async function createRoom() {
      try {
        // Generate room code
        roomCode = Math.floor(1000 + Math.random() * 9000).toString();
        playerId = 'p_' + Date.now();
        isHost = true;
        
        // Save to localStorage
        localStorage.setItem('roomCode', roomCode);
        localStorage.setItem('playerId', playerId);
        localStorage.setItem('isHost', 'true');
        
        // Show lobby
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        hideAll();
        document.getElementById('lobby').classList.remove('hide');
        
        // Create room in Supabase
        const supabase = window.supabase;
        await supabase.from('rooms').insert([
          { code: roomCode, status: 'open', host_player_id: playerId }
        ]);
        
        // Add self as player
        await supabase.from('players').insert([
          { room_code: roomCode, player_id: playerId, player_num: 1 }
        ]);
        
        // Start checking for players
        checkForPlayers();
        
      } catch (error) {
        document.getElementById('createErr').textContent = 'Ø®Ø·Ø£: ' + error.message;
      }
    }
    
    // JOIN ROOM - WORKING!
    async function joinRoom() {
      try {
        const inputCode = document.getElementById('roomCode').value.trim();
        if (!inputCode || inputCode.length !== 4) {
          document.getElementById('joinErr').textContent = 'Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² ØµØ­ÙŠØ­ Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…';
          return;
        }
        
        roomCode = inputCode;
        playerId = 'p_' + Date.now();
        isHost = false;
        
        // Save to localStorage
        localStorage.setItem('roomCode', roomCode);
        localStorage.setItem('playerId', playerId);
        localStorage.setItem('isHost', 'false');
        
        // Check if room exists
        const supabase = window.supabase;
        const { data: room } = await supabase
          .from('rooms')
          .select('*')
          .eq('code', roomCode)
          .single();
          
        if (!room) {
          document.getElementById('joinErr').textContent = 'Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©';
          return;
        }
        
        // Get player count for this room
        const { data: players } = await supabase
          .from('players')
          .select('*')
          .eq('room_code', roomCode);
          
        const playerNum = (players?.length || 0) + 1;
        
        // Add player to room
        await supabase.from('players').insert([
          { room_code: roomCode, player_id: playerId, player_num: playerNum }
        ]);
        
        // Show waiting screen
        hideAll();
        document.getElementById('waiting').classList.remove('hide');
        
        // Start checking for game start
        checkForGameStart();
        
      } catch (error) {
        document.getElementById('joinErr').textContent = 'Ø®Ø·Ø£: ' + error.message;
      }
    }
    
    // START GAME - WORKING!
    async function startGame() {
      try {
        const supabase = window.supabase;
        
        // Get all players
        const { data: players } = await supabase
          .from('players')
          .select('player_id')
          .eq('room_code', roomCode);
          
        if (!players || players.length < 2) {
          alert('ÙŠØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 2');
          return;
        }
        
        // Get random word from YOUR Arabic words
        const { data: words } = await supabase
          .from('words')
          .select('text');
          
        if (!words || words.length === 0) {
          alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          return;
        }
        
        const randomWord = words[Math.floor(Math.random() * words.length)].text;
        
        // Select 1 imposter (or 2 if 5+ players)
        const imposterCount = players.length >= 5 ? 2 : 1;
        const shuffled = [...players].sort(() => Math.random() - 0.5);
        const imposters = shuffled.slice(0, imposterCount).map(p => p.player_id);
        
        // Update room with game data
        await supabase.from('rooms').update({
          state: 'playing',
          word: randomWord,
          imposters: imposters,
          started_at: new Date().toISOString()
        }).eq('code', roomCode);
        
        // Show game screen for host
        showGameScreen();
        
      } catch (error) {
        console.error('Start game error:', error);
      }
    }
    
    // CHECK FOR PLAYERS (Host)
    async function checkForPlayers() {
      setInterval(async () => {
        try {
          const supabase = window.supabase;
          const { data: players } = await supabase
            .from('players')
            .select('player_id, player_num')
            .eq('room_code', roomCode);
            
          if (players) {
            currentPlayers = players;
            const playersHtml = players.map(p => 
              `<div class="player">Ù„Ø§Ø¹Ø¨ ${p.player_num} ${p.player_id === playerId ? '(Ø£Ù†Øª)' : ''}</div>`
            ).join('');
            document.getElementById('playersList').innerHTML = playersHtml;
          }
        } catch (error) {
          console.error('Check players error:', error);
        }
      }, 2000);
    }
    
    // CHECK FOR GAME START (Player)
    async function checkForGameStart() {
      setInterval(async () => {
        try {
          const supabase = window.supabase;
          const { data: room } = await supabase
            .from('rooms')
            .select('*')
            .eq('code', roomCode)
            .single();
            
          if (room && room.state === 'playing') {
            showGameScreen();
          }
          
          // Update player count
          const { data: players } = await supabase
            .from('players')
            .select('*')
            .eq('room_code', roomCode);
            
          if (players) {
            document.getElementById('playerCount').textContent = `Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: ${players.length}`;
          }
          
        } catch (error) {
          console.error('Check game start error:', error);
        }
      }, 2000);
    }
    
    // SHOW GAME SCREEN
    async function showGameScreen() {
      try {
        const supabase = window.supabase;
        const { data: room } = await supabase
          .from('rooms')
          .select('*')
          .eq('code', roomCode)
          .single();
          
        if (!room) return;
        
        hideAll();
        document.getElementById('game').classList.remove('hide');
        
        // Show player number
        const { data: players } = await supabase
          .from('players')
          .select('player_num')
          .eq('room_code', roomCode)
          .eq('player_id', playerId)
          .single();
          
        if (players) {
          document.getElementById('playerTitle').textContent = `Ù„Ø§Ø¹Ø¨ ${players.player_num}`;
        }
        
        // Check if this player is imposter
        const isImposter = room.imposters && room.imposters.includes(playerId);
        const roleBox = document.getElementById('roleBox');
        
        if (isImposter) {
          roleBox.className = 'roleBox spy';
          roleBox.innerHTML = 'ğŸ•µï¸<br><br><strong>Ø£Ù†Øª Ø§Ù„Ù…Ø®Ø¨Ø±!</strong><br><br>Ø­Ø§ÙˆÙ„ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙƒÙ„Ù…Ø©';
        } else {
          roleBox.className = 'roleBox';
          roleBox.innerHTML = `Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©:<br><div class="word">${room.word || '...'}</div>`;
        }
        
        // Show host controls if host
        if (isHost) {
          document.getElementById('hostControls').classList.remove('hide');
        }
        
      } catch (error) {
        console.error('Show game error:', error);
      }
    }
    
    // LEAVE ROOM
    async function leaveRoom() {
      try {
        const supabase = window.supabase;
        await supabase.from('players').delete().eq('player_id', playerId);
        
        // If host, close room
        if (isHost) {
          await supabase.from('rooms').update({ status: 'closed' }).eq('code', roomCode);
        }
        
        // Clear local storage
        localStorage.removeItem('roomCode');
        localStorage.removeItem('playerId');
        localStorage.removeItem('isHost');
        
        goBack();
        
      } catch (error) {
        console.error('Leave room error:', error);
      }
    }
    
    // END GAME
    async function endGame() {
      const supabase = window.supabase;
      await supabase.from('rooms').update({ state: 'ended' }).eq('code', roomCode);
      alert('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©');
    }
    
    // NEW GAME
    async function newGame() {
      const supabase = window.supabase;
      await supabase.from('rooms').update({ 
        state: 'waiting',
        word: null,
        imposters: null,
        started_at: null
      }).eq('code', roomCode);
      
      hideAll();
      document.getElementById('lobby').classList.remove('hide');
    }
    
    // ON PAGE LOAD - RESTORE SESSION
    window.onload = function() {
      const savedRoom = localStorage.getItem('roomCode');
      const savedPlayer = localStorage.getItem('playerId');
      const savedHost = localStorage.getItem('isHost');
      
      if (savedRoom && savedPlayer) {
        roomCode = savedRoom;
        playerId = savedPlayer;
        isHost = savedHost === 'true';
        
        if (isHost) {
          document.getElementById('roomCodeDisplay').textContent = roomCode;
          hideAll();
          document.getElementById('lobby').classList.remove('hide');
          checkForPlayers();
        } else {
          hideAll();
          document.getElementById('waiting').classList.remove('hide');
          checkForGameStart();
        }
      }
    };
  </script>
</body>
</html>
