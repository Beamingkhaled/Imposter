<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <title>Imposter Game üïµÔ∏è</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .container{
      background:#fff;
      border-radius:18px;
      padding:26px;
      max-width:420px;
      width:100%;
      box-shadow:0 10px 40px rgba(0,0,0,.25);
      text-align:center;
    }
    h1{
      color:#667eea;
      margin-bottom:16px;
      font-size:26px;
      font-weight:900;
    }
    label{
      display:block;
      text-align:left;
      font-weight:800;
      margin:12px 0 8px;
      color:#333;
    }
    input{
      width:100%;
      padding:14px;
      border:2px solid #ddd;
      border-radius:12px;
      font-size:18px;
      font-weight:900;
      text-align:center;
    }
    button{
      width:100%;
      padding:16px;
      border:none;
      border-radius:12px;
      margin-top:12px;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
      color:#fff;
      background:#667eea;
    }
    button:hover{ background:#5568d3; }

    .status{
      margin-top:10px;
      font-weight:700;
      color:#444;
      min-height:20px;
    }

    .hidden{ display:none; }

    .pill{
      display:inline-block;
      padding:8px 12px;
      border-radius:999px;
      background:#f1f1ff;
      color:#333;
      font-weight:900;
      margin-bottom:12px;
    }

    .roleBox{
      margin-top:14px;
      padding:22px 16px;
      border-radius:16px;
      min-height:150px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      font-weight:900;
      font-size:22px;
    }
    .normal{
      background:#d4edda;
      color:#155724;
      border:3px solid #28a745;
    }
    .spy{
      background:#f8d7da;
      color:#721c24;
      border:3px solid #dc3545;
      font-size:28px;
    }
    .word{
      margin-top:10px;
      font-size:34px;
      color:#155724;
    }
    .timer{
      margin-top:14px;
      font-weight:900;
      font-size:40px;
      color:#764ba2;
      min-height:46px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üïµÔ∏è Imposter Game</h1>

    <div id="joinScreen">
      <label>Room Code (4 digits)</label>
      <input id="roomCode" type="tel" maxlength="4" placeholder="1234" />
      <button id="joinBtn">Join</button>
      <div class="status" id="joinStatus"></div>
    </div>

    <div id="gameScreen" class="hidden">
      <div class="pill" id="meLabel">Player</div>
      <div class="roleBox" id="roleBox">Waiting for host to start‚Ä¶</div>
      <div class="timer" id="timer"></div>
      <div class="status" id="gameStatus"></div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ======== YOUR SUPABASE CONFIG (already filled) ========
    const SUPABASE_URL = "https://cpegnfupiqdgmqsguyed.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_WKaLUCc9WeXbEcgDfMf1KQ_NKYoTVuU";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ======== STATE ========
    let roomCode = null;
    let playerId = null;
    let playerNum = null;

    let pollTimer = null;
    let timerInterval = null;
    let startedAtSeen = null;

    const joinScreen = document.getElementById("joinScreen");
    const gameScreen = document.getElementById("gameScreen");
    const joinStatus = document.getElementById("joinStatus");

    const meLabel = document.getElementById("meLabel");
    const roleBox = document.getElementById("roleBox");
    const timerEl = document.getElementById("timer");
    const gameStatus = document.getElementById("gameStatus");

    document.getElementById("joinBtn").addEventListener("click", joinRoom);

    // ======== JOIN ========
    async function joinRoom() {
      joinStatus.textContent = "";
      try {
        roomCode = document.getElementById("roomCode").value.trim();
        if (!/^\d{4}$/.test(roomCode)) {
          return alert("Enter a valid 4-digit code");
        }

        // Create a playerId for THIS session (works in anonymous too)
        playerId = sessionStorage.getItem("playerId") || ("p_" + cryptoRandom());
        sessionStorage.setItem("playerId", playerId);

        // Check room exists & open
        const { data: room, error: rerr } = await supabase
          .from("rooms")
          .select("*")
          .eq("code", roomCode)
          .maybeSingle();

        if (rerr) throw rerr;
        if (!room) {
          joinStatus.textContent = "Room not found.";
          return;
        }
        if (room.status !== "open") {
          joinStatus.textContent = "Room is closed.";
          return;
        }

        // If already joined, get player_num
        const { data: existing, error: exErr } = await supabase
          .from("players")
          .select("player_num")
          .eq("room_code", roomCode)
          .eq("player_id", playerId)
          .maybeSingle();

        if (exErr) throw exErr;

        if (existing?.player_num) {
          playerNum = existing.player_num;
        } else {
          // assign next number
          const { data: countRows, error: cntErr } = await supabase
            .from("players")
            .select("id", { count: "exact", head: true })
            .eq("room_code", roomCode);

          if (cntErr) throw cntErr;

          const nextNum = (countRows === null ? 0 : 0) + 1; // head:true returns null data, but count available in response meta
          // Supabase JS returns count on the response object; easiest: re-query list length
          const { data: plist, error: perr } = await supabase
            .from("players")
            .select("player_num")
            .eq("room_code", roomCode);

          if (perr) throw perr;

          const used = new Set((plist || []).map(x => x.player_num));
          let assign = 1;
          while (used.has(assign)) assign++;

          const { error: insErr } = await supabase
            .from("players")
            .insert([{ room_code: roomCode, player_id: playerId, player_num: assign }]);

          if (insErr) throw insErr;

          playerNum = assign;
        }

        sessionStorage.setItem("roomCode", roomCode);
        sessionStorage.setItem("playerNum", String(playerNum));

        showGame();
        startPolling();

      } catch (e) {
        console.error(e);
        joinStatus.textContent = e?.message || "Join failed.";
      }
    }

    function showGame() {
      joinScreen.classList.add("hidden");
      gameScreen.classList.remove("hidden");
      meLabel.textContent = `You are Player ${playerNum}`;
      roleBox.className = "roleBox";
      roleBox.textContent = "Waiting for host to start‚Ä¶";
      timerEl.textContent = "";
      gameStatus.textContent = "";
    }

    // ======== POLL ROOM STATE ========
    function startPolling() {
      if (pollTimer) clearInterval(pollTimer);

      pollTimer = setInterval(async () => {
        try {
          const { data: room, error } = await supabase
            .from("rooms")
            .select("*")
            .eq("code", roomCode)
            .maybeSingle();

          if (error) throw error;
          if (!room) return;

          if (room.status !== "open") {
            roleBox.className = "roleBox";
            roleBox.textContent = "Room closed.";
            gameStatus.textContent = "";
            stopTimer();
            return;
          }

          if (room.state === "playing" && room.started_at) {
            showRole(room);
            if (startedAtSeen !== room.started_at) {
              startedAtSeen = room.started_at;
              startTimer(new Date(room.started_at).getTime());
            }
          } else {
            roleBox.className = "roleBox";
            roleBox.textContent = "Waiting for host to start‚Ä¶";
            gameStatus.textContent = "";
            stopTimer();
          }

        } catch (e) {
          console.error("poll error", e);
        }
      }, 1200);
    }

    function showRole(room) {
      if (room.spy_player_id === playerId) {
        roleBox.className = "roleBox spy";
        roleBox.innerHTML = "üïµÔ∏è YOU ARE THE IMPOSTER";
        gameStatus.textContent = "Don‚Äôt get caught.";
      } else {
        roleBox.className = "roleBox normal";
        roleBox.innerHTML = `SECRET WORD:<div class="word">${escapeHtml(room.word || "")}</div>`;
        gameStatus.textContent = "Blend in.";
      }
    }

    // ======== TIMER (5 minutes) ========
    function startTimer(startMs) {
      stopTimer();
      const duration = 5 * 60; // seconds

      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startMs) / 1000);
        const remaining = Math.max(0, duration - elapsed);
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        timerEl.textContent = remaining > 0
          ? `${mins}:${String(secs).padStart(2, "0")}`
          : "TIME UP ‚è∞";
      }, 500);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerEl.textContent = "";
      startedAtSeen = null;
    }

    // ======== UTIL ========
    function cryptoRandom() {
      // short random string
      const arr = new Uint8Array(16);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b => b.toString(16).padStart(2,"0")).join("");
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    // ======== AUTO RESUME (same tab session) ========
    window.addEventListener("load", () => {
      const savedRoom = sessionStorage.getItem("roomCode");
      const savedNum = sessionStorage.getItem("playerNum");
      const savedPid = sessionStorage.getItem("playerId");
      if (savedRoom && savedNum && savedPid) {
        roomCode = savedRoom;
        playerNum = parseInt(savedNum, 10);
        playerId = savedPid;
        showGame();
        startPolling();
      }
    });

    window.addEventListener("beforeunload", () => {
      if (pollTimer) clearInterval(pollTimer);
      stopTimer();
    });
  </script>
</body>
</html>
