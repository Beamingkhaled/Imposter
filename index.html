<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø± - ÙŠØ¹Ù…Ù„!</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Arial, sans-serif;
      background: repeating-linear-gradient(45deg, #ec4899, #ec4899 10px, #ffffff 10px, #ffffff 20px);
      min-height:100vh;
      padding:20px;
      direction: rtl;
    }
    .container {
      background:#fff;
      border:5px solid #ec4899;
      border-radius:15px;
      padding:25px;
      max-width:450px;
      margin:0 auto;
    }
    h1 { text-align:center; color:#ec4899; margin-bottom:20px; }
    button {
      width:100%;
      padding:15px;
      margin:10px 0;
      font-size:18px;
      border-radius:8px;
      border:none;
      background:#ec4899;
      color:white;
      cursor:pointer;
      font-weight:bold;
    }
    button:hover { opacity:0.9; }
    .btn-grey { background:#666; }
    .hide { display:none; }
    .code {
      font-size:80px;
      text-align:center;
      font-weight:900;
      color:#ec4899;
      margin:20px 0;
      letter-spacing:10px;
    }
    .status {
      color:red;
      text-align:center;
      margin:10px 0;
      min-height:20px;
    }
    input {
      width:100%;
      padding:15px;
      font-size:24px;
      text-align:center;
      border:3px solid #ec4899;
      border-radius:8px;
      margin:10px 0;
    }
    .roleBox {
      padding:20px;
      margin:20px 0;
      border:5px solid #ec4899;
      border-radius:15px;
      text-align:center;
      font-size:24px;
      min-height:200px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
    }
    .spy {
      background:#ec4899;
      color:white;
    }
    .word {
      font-size:48px;
      color:#ec4899;
      margin-top:10px;
      font-weight:bold;
      line-height:1.2;
    }
    .player {
      background:#f0f0f0;
      padding:10px;
      margin:5px 0;
      border-radius:8px;
      border:2px solid #ec4899;
    }
    .connection-status {
      background:#fce7f3;
      padding:10px;
      border-radius:8px;
      margin-bottom:15px;
      text-align:center;
      font-size:14px;
      border:2px solid #fbcfe8;
    }
    .success { color:#065f46; background:#d1fae5; }
    .error { color:#991b1b; background:#fee2e2; }
  </style>
</head>
<body>
  <div class="container">
    <div class="connection-status" id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <h1>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø±</h1>
    <p style="text-align:center; color:#666; font-size:12px;">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</p>
    
    <div id="menu">
      <button onclick="showCreate()">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
      <button onclick="showJoin()" class="btn-grey">Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</button>
    </div>
    
    <div id="create" class="hide">
      <h2>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h2>
      <button onclick="createRoom()">ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</button>
      <button onclick="goBack()" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="createErr" class="status"></div>
    </div>
    
    <div id="join" class="hide">
      <h2>Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</h2>
      <input id="codeInput" type="text" maxlength="4" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²">
      <button onclick="joinRoom()">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</button>
      <button onclick="goBack()" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="joinErr" class="status"></div>
    </div>
    
    <div id="lobby" class="hide">
      <h2>ğŸ‘‘ Ø£Ù†Øª Ø§Ù„Ù…Ø¶ÙŠÙ</h2>
      <div class="code" id="roomCode">0000</div>
      <div id="playersList">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      <button onclick="closeRoom()" class="btn-grey">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©</button>
      <div id="lobbyErr" class="status"></div>
    </div>
    
    <div id="waiting" class="hide">
      <h2 id="waitTitle">Ù„Ø§Ø¹Ø¨</h2>
      <div class="roleBox">
        Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...
        <div id="waitCount" style="margin-top:10px; font-size:16px;"></div>
      </div>
      <button onclick="leaveRoom()" class="btn-grey">ØªØ±Ùƒ Ø§Ù„ØºØ±ÙØ©</button>
      <div id="waitErr" class="status"></div>
    </div>
    
    <div id="game" class="hide">
      <h2 id="gameTitle">Ù„Ø§Ø¹Ø¨</h2>
      <div class="roleBox" id="roleBox">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div id="hostControls" class="hide">
        <button onclick="endGame()">Ø§Ù†Ù‡ÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        <button onclick="newGame()" class="btn-grey">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
      <button onclick="leaveRoom()" class="btn-grey">ØªØ±Ùƒ Ø§Ù„ØºØ±ÙØ©</button>
      <div id="gameErr" class="status"></div>
    </div>
  </div>

  <script>
    // ========== GAME STATE ==========
    let supabase = null;
    let roomCode = '';
    let playerId = '';
    let isHost = false;
    let playerNum = 0;
    let poll = null;
    
    // ========== INITIALIZE ==========
    async function init() {
      try {
        // Wait for Supabase to load
        if (!window.supabase) {
          await loadSupabase();
        }
        
        // Create Supabase client
        supabase = window.supabase.createClient(
          'https://cpegnfupiqdgmqsguyed.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwZWduZnVwaXFkZ21xc2d1eWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI4NTA5ODMsImV4cCI6MjA0ODQyNjk4M30.zHRNKkZ5Lly4q4fRZQzT5iWTtq67j3JNkaf3-_W8BkI'
        );
        
        // Test connection
        const { data } = await supabase.from('words').select('text').limit(1);
        
        if (data && data.length > 0) {
          document.getElementById('status').textContent = 'âœ… Ù…ØªØµÙ„ - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø¨';
          document.getElementById('status').className = 'connection-status success';
        } else {
          document.getElementById('status').textContent = 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
          document.getElementById('status').className = 'connection-status error';
        }
        
      } catch (error) {
        console.error('Init error:', error);
        document.getElementById('status').textContent = 'âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        document.getElementById('status').className = 'connection-status error';
      }
    }
    
    async function loadSupabase() {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    
    // ========== UI FUNCTIONS ==========
    function showCreate() {
      hideAll();
      document.getElementById('create').classList.remove('hide');
      document.getElementById('createErr').textContent = '';
    }
    
    function showJoin() {
      hideAll();
      document.getElementById('join').classList.remove('hide');
      document.getElementById('codeInput').focus();
      document.getElementById('joinErr').textContent = '';
    }
    
    function goBack() {
      if (poll) clearInterval(poll);
      hideAll();
      document.getElementById('menu').classList.remove('hide');
    }
    
    function hideAll() {
      ['menu','create','join','lobby','waiting','game'].forEach(id => {
        document.getElementById(id).classList.add('hide');
      });
    }
    
    // ========== CREATE ROOM ==========
    async function createRoom() {
      const errEl = document.getElementById('createErr');
      errEl.textContent = '';
      
      try {
        // Generate room code
        roomCode = Math.floor(1000 + Math.random() * 9000).toString();
        playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        isHost = true;
        playerNum = 1;
        
        console.log('Creating room:', roomCode);
        
        // Check if room already exists
        const { data: existingRoom } = await supabase
          .from('rooms')
          .select('code')
          .eq('code', roomCode)
          .maybeSingle();
          
        if (existingRoom) {
          errEl.textContent = 'Ø§Ù„Ø±Ù…Ø² Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
          return;
        }
        
        // Create room in database
        const { error: roomError } = await supabase.from('rooms').insert([{
          code: roomCode,
          status: 'open',
          state: 'waiting',
          host_player_id: playerId,
          created_at: new Date().toISOString()
        }]);
        
        if (roomError) throw roomError;
        
        // Add host as player 1
        const { error: playerError } = await supabase.from('players').insert([{
          room_code: roomCode,
          player_id: playerId,
          player_num: 1,
          joined_at: new Date().toISOString()
        }]);
        
        if (playerError) throw playerError;
        
        // Save to localStorage
        localStorage.setItem('imposter_room', JSON.stringify({
          code: roomCode,
          playerId: playerId,
          playerNum: playerNum,
          isHost: isHost
        }));
        
        // Show lobby
        document.getElementById('roomCode').textContent = roomCode;
        hideAll();
        document.getElementById('lobby').classList.remove('hide');
        
        // Start polling
        startPolling();
        
      } catch (error) {
        console.error('Create room error:', error);
        errEl.textContent = 'Ø®Ø·Ø£: ' + (error.message || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©');
      }
    }
    
    // ========== JOIN ROOM ==========
    async function joinRoom() {
      const errEl = document.getElementById('joinErr');
      errEl.textContent = '';
      
      try {
        const code = document.getElementById('codeInput').value.trim();
        
        if (!/^\d{4}$/.test(code)) {
          errEl.textContent = 'Ø£Ø¯Ø®Ù„ 4 Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø©';
          return;
        }
        
        roomCode = code;
        playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        isHost = false;
        
        console.log('Joining room:', roomCode);
        
        // Check if room exists
        const { data: room, error: roomError } = await supabase
          .from('rooms')
          .select('*')
          .eq('code', roomCode)
          .eq('status', 'open')
          .maybeSingle();
          
        if (roomError) throw roomError;
        if (!room) {
          errEl.textContent = 'âŒ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ù…ØºÙ„Ù‚Ø©';
          return;
        }
        
        // Get current players
        const { data: players, error: playersError } = await supabase
          .from('players')
          .select('player_num')
          .eq('room_code', roomCode);
          
        if (playersError) throw playersError;
        
        // Find next player number
        const usedNumbers = players ? players.map(p => p.player_num) : [];
        let nextNum = 1;
        while (usedNumbers.includes(nextNum)) nextNum++;
        playerNum = nextNum;
        
        // Add player to room
        const { error: addError } = await supabase.from('players').insert([{
          room_code: roomCode,
          player_id: playerId,
          player_num: playerNum,
          joined_at: new Date().toISOString()
        }]);
        
        if (addError) throw addError;
        
        // Save to localStorage
        localStorage.setItem('imposter_room', JSON.stringify({
          code: roomCode,
          playerId: playerId,
          playerNum: playerNum,
          isHost: isHost
        }));
        
        // Show waiting screen
        document.getElementById('waitTitle').textContent = 'Ù„Ø§Ø¹Ø¨ ' + playerNum;
        hideAll();
        document.getElementById('waiting').classList.remove('hide');
        
        // Start polling
        startPolling();
        
      } catch (error) {
        console.error('Join room error:', error);
        errEl.textContent = 'Ø®Ø·Ø£: ' + (error.message || 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…');
      }
    }
    
    // ========== START GAME ==========
    async function startGame() {
      const errEl = document.getElementById('lobbyErr');
      errEl.textContent = '';
      
      try {
        // Get all players
        const { data: players, error: playersError } = await supabase
          .from('players')
          .select('player_id')
          .eq('room_code', roomCode);
          
        if (playersError) throw playersError;
        
        if (!players || players.length < 2) {
          errEl.textContent = 'ÙŠØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 2';
          return;
        }
        
        // Get random Arabic word from YOUR database
        const { data: words, error: wordsError } = await supabase
          .from('words')
          .select('text');
          
        if (wordsError) throw wordsError;
        if (!words || words.length === 0) {
          errEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
          return;
        }
        
        const randomWord = words[Math.floor(Math.random() * words.length)].text;
        
        // Determine imposters
        const playerCount = players.length;
        const imposterCount = playerCount >= 5 ? 2 : 1;
        const shuffled = [...players].sort(() => Math.random() - 0.5);
        const imposters = shuffled.slice(0, imposterCount).map(p => p.player_id);
        
        // Start game in database
        const { error: gameError } = await supabase
          .from('rooms')
          .update({
            state: 'playing',
            word: randomWord,
            spy_player_id: imposters[0],
            imposters: imposters,
            started_at: new Date().toISOString()
          })
          .eq('code', roomCode);
          
        if (gameError) throw gameError;
        
        console.log('Game started! Word:', randomWord);
        
      } catch (error) {
        console.error('Start game error:', error);
        errEl.textContent = 'Ø®Ø·Ø£: ' + (error.message || 'ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©');
      }
    }
    
    // ========== POLLING ==========
    function startPolling() {
      if (poll) clearInterval(poll);
      
      poll = setInterval(async () => {
        try {
          if (!roomCode) return;
          
          // Get room status
          const { data: room, error: roomError } = await supabase
            .from('rooms')
            .select('*')
            .eq('code', roomCode)
            .maybeSingle();
            
          if (roomError) throw roomError;
          
          if (!room || room.status !== 'open') {
            clearInterval(poll);
            alert('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©');
            localStorage.removeItem('imposter_room');
            goBack();
            return;
          }
          
          // Get players
          const { data: players, error: playersError } = await supabase
            .from('players')
            .select('player_id, player_num')
            .eq('room_code', roomCode)
            .order('player_num');
            
          if (playersError) throw playersError;
          
          // Update display
          if (isHost && room.state === 'waiting') {
            updateLobby(players);
          } else if (!isHost && room.state === 'waiting') {
            updateWaiting(players);
          }
          
          // Game started
          if (room.state === 'playing') {
            showGame(room);
          }
          
        } catch (error) {
          console.error('Polling error:', error);
        }
      }, 2000);
    }
    
    function updateLobby(players) {
      if (!players) return;
      
      let html = '';
      players.forEach(player => {
        html += `<div class="player">
          Ù„Ø§Ø¹Ø¨ ${player.player_num} 
          ${player.player_id === playerId ? '<strong>(Ø£Ù†Øª - Ø§Ù„Ù…Ø¶ÙŠÙ)</strong>' : ''}
        </div>`;
      });
      
      document.getElementById('playersList').innerHTML = html;
    }
    
    function updateWaiting(players) {
      if (!players) return;
      document.getElementById('waitCount').textContent = `Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: ${players.length}`;
    }
    
    function showGame(room) {
      hideAll();
      document.getElementById('game').classList.remove('hide');
      
      document.getElementById('gameTitle').textContent = 'Ù„Ø§Ø¹Ø¨ ' + playerNum;
      
      const isImposter = room.imposters && room.imposters.includes(playerId);
      const roleBox = document.getElementById('roleBox');
      
      if (isImposter) {
        roleBox.className = 'roleBox spy';
        roleBox.innerHTML = 'ğŸ•µï¸<br><br><strong>Ø£Ù†Øª Ø§Ù„Ù…Ø®Ø¨Ø±!</strong><br><br>Ø­Ø§ÙˆÙ„ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙƒÙ„Ù…Ø©';
      } else {
        roleBox.className = 'roleBox';
        roleBox.innerHTML = `Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©:<br><div class="word">${room.word || '...'}</div>`;
      }
      
      if (isHost) {
        document.getElementById('hostControls').classList.remove('hide');
      }
    }
    
    // ========== OTHER FUNCTIONS ==========
    async function closeRoom() {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©ØŸ Ø³ÙŠØªÙ… ÙØµÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.')) return;
      
      try {
        await supabase
          .from('rooms')
          .update({ status: 'closed' })
          .eq('code', roomCode);
          
        await supabase
          .from('players')
          .delete()
          .eq('room_code', roomCode);
          
        localStorage.removeItem('imposter_room');
        goBack();
        
      } catch (error) {
        console.error('Close room error:', error);
      }
    }
    
    async function leaveRoom() {
      try {
        await supabase
          .from('players')
          .delete()
          .eq('player_id', playerId);
          
        localStorage.removeItem('imposter_room');
        goBack();
        
      } catch (error) {
        console.error('Leave room error:', error);
      }
    }
    
    async function endGame() {
      try {
        await supabase
          .from('rooms')
          .update({ state: 'ended' })
          .eq('code', roomCode);
          
        alert('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©');
        
      } catch (error) {
        console.error('End game error:', error);
      }
    }
    
    async function newGame() {
      try {
        await supabase
          .from('rooms')
          .update({
            state: 'waiting',
            word: null,
            spy_player_id: null,
            imposters: null,
            started_at: null
          })
          .eq('code', roomCode);
          
        hideAll();
        document.getElementById('lobby').classList.remove('hide');
        
      } catch (error) {
        console.error('New game error:', error);
      }
    }
    
    // ========== RESTORE SESSION ==========
    function restoreSession() {
      try {
        const saved = localStorage.getItem('imposter_room');
        if (!saved) return;
        
        const data = JSON.parse(saved);
        roomCode = data.code;
        playerId = data.playerId;
        playerNum = data.playerNum;
        isHost = data.isHost;
        
        if (isHost) {
          document.getElementById('roomCode').textContent = roomCode;
          hideAll();
          document.getElementById('lobby').classList.remove('hide');
          startPolling();
        } else {
          document.getElementById('waitTitle').textContent = 'Ù„Ø§Ø¹Ø¨ ' + playerNum;
          hideAll();
          document.getElementById('waiting').classList.remove('hide');
          startPolling();
        }
        
      } catch (error) {
        console.error('Restore session error:', error);
        localStorage.removeItem('imposter_room');
      }
    }
    
    // ========== START EVERYTHING ==========
    // Fix: Wait for page to load, THEN init
    window.addEventListener('DOMContentLoaded', () => {
      // Setup input formatting
      document.getElementById('codeInput').addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').slice(0, 4);
      });
      
      // Initialize
      init().then(() => {
        restoreSession();
      });
    });
  </script>
</body>
</html>
