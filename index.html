<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Arial, sans-serif;
      background: repeating-linear-gradient(45deg, #22c55e, #22c55e 10px, #ffffff 10px, #ffffff 20px);
      min-height:100vh;
      padding:20px;
      direction: rtl;
    }
    .container {
      background:#fff;
      border:5px solid #22c55e;
      border-radius:15px;
      padding:25px;
      max-width:450px;
      margin:0 auto;
    }
    h1 { text-align:center; color:#22c55e; margin-bottom:20px; }
    button {
      width:100%;
      padding:15px;
      margin:10px 0;
      font-size:18px;
      border-radius:8px;
      border:none;
      background:#22c55e;
      color:white;
      cursor:pointer;
      font-weight:bold;
    }
    button:active { background:#16a34a; }
    .btn-grey { background:#666; }
    .hide { display:none; }
    .code {
      font-size:80px;
      text-align:center;
      font-weight:900;
      color:#22c55e;
      margin:20px 0;
      letter-spacing:10px;
    }
    .status {
      color:red;
      text-align:center;
      margin:10px 0;
      min-height:20px;
    }
    input {
      width:100%;
      padding:15px;
      font-size:24px;
      text-align:center;
      border:3px solid #22c55e;
      border-radius:8px;
      margin:10px 0;
    }
    .roleBox {
      padding:20px;
      margin:20px 0;
      border:5px solid #22c55e;
      border-radius:15px;
      text-align:center;
      font-size:24px;
      min-height:200px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
    }
    .spy {
      background:#22c55e;
      color:white;
    }
    .word {
      font-size:48px;
      color:#22c55e;
      margin-top:10px;
      font-weight:bold;
      line-height:1.2;
    }
    .player {
      background:#f0f0f0;
      padding:10px;
      margin:5px 0;
      border-radius:8px;
      border:2px solid #22c55e;
    }
    .connection-status {
      background:#e3f2fd;
      padding:10px;
      border-radius:8px;
      margin-bottom:15px;
      text-align:center;
      font-size:14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="connection-status" id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <h1>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø±</h1>
    
    <div id="menu">
      <button id="createBtn">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
      <button id="joinBtn" class="btn-grey">Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</button>
    </div>
    
    <div id="create" class="hide">
      <h2>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h2>
      <button id="generateBtn">ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</button>
      <button id="backBtn1" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="createErr" class="status"></div>
    </div>
    
    <div id="join" class="hide">
      <h2>Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</h2>
      <input id="codeInput" type="text" maxlength="4" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²" pattern="\d*">
      <button id="joinBtn2">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</button>
      <button id="backBtn2" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="joinErr" class="status"></div>
    </div>
    
    <div id="lobby" class="hide">
      <h2>ğŸ‘‘ Ø£Ù†Øª Ø§Ù„Ù…Ø¶ÙŠÙ</h2>
      <div class="code" id="roomCode">0000</div>
      <div id="playersList">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <button id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      <button id="closeBtn" class="btn-grey">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©</button>
      <div id="lobbyErr" class="status"></div>
    </div>
    
    <div id="waiting" class="hide">
      <h2 id="waitTitle">Ù„Ø§Ø¹Ø¨</h2>
      <div class="roleBox">
        Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...
        <div id="waitCount" style="margin-top:10px; font-size:16px;"></div>
      </div>
      <button id="leaveBtn" class="btn-grey">ØªØ±Ùƒ Ø§Ù„ØºØ±ÙØ©</button>
      <div id="waitErr" class="status"></div>
    </div>
    
    <div id="game" class="hide">
      <h2 id="gameTitle">Ù„Ø§Ø¹Ø¨</h2>
      <div class="roleBox" id="roleBox">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div id="hostControls" class="hide">
        <button id="endBtn">Ø§Ù†Ù‡ÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        <button id="newBtn" class="btn-grey">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
      <button id="leaveBtn2" class="btn-grey">ØªØ±Ùƒ Ø§Ù„ØºØ±ÙØ©</button>
      <div id="gameErr" class="status"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ========== SIMPLE GAME ==========
    let supabase = null;
    let roomCode = '';
    let playerId = '';
    let isHost = false;
    let playerNum = 0;
    let poll = null;
    
    // Initialize
    async function init() {
      try {
        supabase = window.supabase.createClient(
          'https://cpegnfupiqdgmqsguyed.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwZWduZnVwaXFkZ21xc2d1eWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI4NTA5ODMsImV4cCI6MjA0ODQyNjk4M30.zHRNKkZ5Lly4q4fRZQzT5iWTtq67j3JNkaf3-_W8BkI'
        );
        
        // Test connection
        const { data } = await supabase.from('words').select('text').limit(1);
        document.getElementById('status').textContent = 'âœ… Ù…ØªØµÙ„ - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø¨';
        document.getElementById('status').style.background = '#d4edda';
        
        setupEvents();
        restoreSession();
      } catch (e) {
        document.getElementById('status').textContent = 'âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
      }
    }
    
    function setupEvents() {
      document.getElementById('createBtn').onclick = () => showScreen('create');
      document.getElementById('joinBtn').onclick = () => showScreen('join');
      document.getElementById('generateBtn').onclick = createRoom;
      document.getElementById('joinBtn2').onclick = joinRoom;
      document.getElementById('backBtn1').onclick = () => showScreen('menu');
      document.getElementById('backBtn2').onclick = () => showScreen('menu');
      document.getElementById('startBtn').onclick = startGame;
      document.getElementById('closeBtn').onclick = closeRoom;
      document.getElementById('leaveBtn').onclick = leaveRoom;
      document.getElementById('leaveBtn2').onclick = leaveRoom;
      document.getElementById('endBtn').onclick = endGame;
      document.getElementById('newBtn').onclick = newGame;
      
      document.getElementById('codeInput').oninput = function() {
        this.value = this.value.replace(/\D/g, '').slice(0, 4);
      };
    }
    
    function showScreen(screen) {
      document.querySelectorAll('.container > div').forEach(div => div.classList.add('hide'));
      document.getElementById(screen).classList.remove('hide');
    }
    
    // ========== CREATE ROOM ==========
    async function createRoom() {
      try {
        roomCode = Math.floor(1000 + Math.random() * 9000).toString();
        playerId = 'p' + Date.now();
        isHost = true;
        playerNum = 1;
        
        // Create room
        await supabase.from('rooms').insert([{
          code: roomCode,
          host_player_id: playerId
        }]);
        
        // Add self as player
        await supabase.from('players').insert([{
          room_code: roomCode,
          player_id: playerId,
          player_num: 1
        }]);
        
        // Show lobby
        document.getElementById('roomCode').textContent = roomCode;
        showScreen('lobby');
        startPolling();
        
      } catch (e) {
        document.getElementById('createErr').textContent = 'Ø®Ø·Ø£: ' + e.message;
      }
    }
    
    // ========== JOIN ROOM ==========
    async function joinRoom() {
      try {
        const code = document.getElementById('codeInput').value;
        if (code.length !== 4) {
          document.getElementById('joinErr').textContent = 'Ø£Ø¯Ø®Ù„ 4 Ø£Ø±Ù‚Ø§Ù…';
          return;
        }
        
        roomCode = code;
        playerId = 'p' + Date.now();
        isHost = false;
        
        // Check room exists
        const { data: room } = await supabase
          .from('rooms')
          .select('*')
          .eq('code', roomCode)
          .single();
          
        if (!room) {
          document.getElementById('joinErr').textContent = 'Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©';
          return;
        }
        
        // Get player number
        const { data: players } = await supabase
          .from('players')
          .select('player_num')
          .eq('room_code', roomCode);
          
        playerNum = (players?.length || 0) + 1;
        
        // Join room
        await supabase.from('players').insert([{
          room_code: roomCode,
          player_id: playerId,
          player_num: playerNum
        }]);
        
        // Show waiting
        document.getElementById('waitTitle').textContent = 'Ù„Ø§Ø¹Ø¨ ' + playerNum;
        showScreen('waiting');
        startPolling();
        
      } catch (e) {
        document.getElementById('joinErr').textContent = 'Ø®Ø·Ø£: ' + e.message;
      }
    }
    
    // ========== START GAME ==========
    async function startGame() {
      try {
        // Get players
        const { data: players } = await supabase
          .from('players')
          .select('player_id')
          .eq('room_code', roomCode);
          
        if (!players || players.length < 2) {
          alert('ÙŠØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 2');
          return;
        }
        
        // Get random Arabic word
        const { data: words } = await supabase.from('words').select('text');
        const word = words[Math.floor(Math.random() * words.length)].text;
        
        // Select imposters
        const imposterCount = players.length >= 5 ? 2 : 1;
        const shuffled = [...players].sort(() => Math.random() - 0.5);
        const imposters = shuffled.slice(0, imposterCount).map(p => p.player_id);
        
        // Start game
        await supabase.from('rooms').update({
          state: 'playing',
          word: word,
          imposters: imposters,
          started_at: new Date().toISOString()
        }).eq('code', roomCode);
        
      } catch (e) {
        document.getElementById('lobbyErr').textContent = 'Ø®Ø·Ø£: ' + e.message;
      }
    }
    
    // ========== POLLING ==========
    function startPolling() {
      if (poll) clearInterval(poll);
      poll = setInterval(async () => {
        try {
          // Get room
          const { data: room } = await supabase
            .from('rooms')
            .select('*')
            .eq('code', roomCode)
            .single();
            
          if (!room || room.status !== 'open') {
            alert('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©');
            leaveRoom();
            return;
          }
          
          // Get players
          const { data: players } = await supabase
            .from('players')
            .select('player_id, player_num')
            .eq('room_code', roomCode);
            
          // Update display
          if (isHost && room.state === 'waiting') {
            const list = players.map(p => 
              `<div class="player">Ù„Ø§Ø¹Ø¨ ${p.player_num} ${p.player_id === playerId ? '(Ø£Ù†Øª)' : ''}</div>`
            ).join('');
            document.getElementById('playersList').innerHTML = list;
          } else if (!isHost && room.state === 'waiting') {
            document.getElementById('waitCount').textContent = `Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: ${players.length}`;
          }
          
          // Game started
          if (room.state === 'playing') {
            showGame(room);
          }
          
        } catch (e) {
          console.error('Poll error:', e);
        }
      }, 2000);
    }
    
    function showGame(room) {
      showScreen('game');
      document.getElementById('gameTitle').textContent = 'Ù„Ø§Ø¹Ø¨ ' + playerNum;
      
      const isImposter = room.imposters && room.imposters.includes(playerId);
      const roleBox = document.getElementById('roleBox');
      
      if (isImposter) {
        roleBox.className = 'roleBox spy';
        roleBox.innerHTML = 'ğŸ•µï¸<br><br><strong>Ø£Ù†Øª Ø§Ù„Ù…Ø®Ø¨Ø±!</strong>';
      } else {
        roleBox.className = 'roleBox';
        roleBox.innerHTML = `Ø§Ù„ÙƒÙ„Ù…Ø©:<br><div class="word">${room.word}</div>`;
      }
      
      if (isHost) {
        document.getElementById('hostControls').classList.remove('hide');
      }
    }
    
    // ========== OTHER FUNCTIONS ==========
    async function closeRoom() {
      await supabase.from('rooms').update({ status: 'closed' }).eq('code', roomCode);
      await supabase.from('players').delete().eq('room_code', roomCode);
      showScreen('menu');
    }
    
    async function leaveRoom() {
      await supabase.from('players').delete().eq('player_id', playerId);
      showScreen('menu');
    }
    
    async function endGame() {
      await supabase.from('rooms').update({ state: 'ended' }).eq('code', roomCode);
    }
    
    async function newGame() {
      await supabase.from('rooms').update({
        state: 'waiting',
        word: null,
        imposters: null
      }).eq('code', roomCode);
      showScreen('lobby');
    }
    
    function restoreSession() {
      // Not needed for now
    }
    
    // Start
    init();
  </script>
</body>
</html>
