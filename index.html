<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø± - Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      background: repeating-linear-gradient(
        45deg,
        #22c55e,
        #22c55e 10px,
        #ffffff 10px,
        #ffffff 20px
      );
      min-height:100vh;
      padding:20px;
      direction: rtl;
    }
    .container{
      background:#fff;
      border:5px solid #22c55e;
      border-radius:15px;
      padding:25px;
      max-width:500px;
      margin:0 auto;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }
    h1{ text-align:center; color:#22c55e; margin-bottom:20px; font-size:28px; }
    h2{ color:#22c55e; margin:15px 0; }
    input, button{ 
      width:100%; 
      padding:15px; 
      margin:10px 0; 
      font-size:18px; 
      border-radius:8px; 
      border:3px solid #22c55e;
      box-sizing:border-box;
      transition: all 0.3s;
    }
    button{ 
      background:#22c55e; 
      color:#fff; 
      cursor:pointer; 
      font-weight:bold;
      border:none;
    }
    button:hover{ transform: scale(1.02); }
    button:active{ background:#16a34a; }
    .btn-grey{ background:#808080; }
    .btn-grey:hover { background:#666666; }
    .hide{ display:none !important; }
    .code{ 
      font-size:70px; 
      text-align:center; 
      font-weight:900; 
      color:#22c55e; 
      margin:20px 0;
      letter-spacing:8px;
      text-shadow: 2px 2px 0 #ccc;
    }
    .status{ 
      color:#d00; 
      font-weight:bold; 
      margin:10px 0; 
      text-align:center;
      min-height:24px;
    }
    .success { color: #008000; }
    .roleBox{
      padding:30px;
      margin:20px 0;
      border-radius:15px;
      border:5px solid #22c55e;
      font-size:24px;
      font-weight:900;
      text-align:center;
      min-height:200px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
    }
    .normal{ background:#fff; color:#22c55e; }
    .spy{ background:#22c55e; color:#fff; font-size:32px; }
    .waiting{ background:#f5f5f5; color:#666; }
    .word{ 
      font-size:56px; 
      margin-top:15px; 
      color:#22c55e;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      line-height:1.2;
    }
    .players{ margin:15px 0; }
    .player{ 
      background:#f0f0f0; 
      border:2px solid #22c55e; 
      padding:12px; 
      margin:8px 0; 
      border-radius:8px;
      font-weight:bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .timer{ 
      font-size:50px; 
      font-weight:900; 
      text-align:center; 
      color:#22c55e; 
      margin:20px 0;
    }
    .pill{
      display:inline-block;
      padding:8px 15px;
      background:#22c55e;
      color:#fff;
      border-radius:20px;
      font-weight:bold;
      margin:10px 0;
    }
    input:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
    }
    #codeInput {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 5px;
      direction: ltr;
    }
    .info {
      background: #d1ecf1;
      border: 2px solid #bee5eb;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      color: #0c5460;
      font-size: 14px;
      text-align: center;
    }
    .player-status {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 10px;
      background: #22c55e;
      color: white;
    }
    .player-host {
      background: #ef4444;
    }
    .player-you {
      background: #3b82f6;
    }
    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: bold;
    }
    .connected { background: #22c55e; color: white; }
    .disconnected { background: #ef4444; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø± - Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h1>
    <p style="text-align:center; font-size:11px; color:#666; margin-bottom:15px;">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ - ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</p>
    
    <div class="info" id="connectionInfo">
      Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
    </div>

    <div id="menu">
      <button type="button" id="createBtn">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
      <button type="button" id="joinBtn" class="btn-grey">Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</button>
      <div id="menuErr" class="status"></div>
    </div>

    <div id="create" class="hide">
      <h2>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
      <button type="button" id="generateBtn">ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</button>
      <button type="button" id="backFromCreate" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="createErr" class="status"></div>
    </div>

    <div id="join" class="hide">
      <h2>Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</h2>
      <input id="codeInput" type="text" maxlength="4" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…" pattern="\d*" inputmode="numeric">
      <button type="button" id="joinNowBtn">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</button>
      <button type="button" id="backFromJoin" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="joinErr" class="status"></div>
    </div>

    <div id="lobby" class="hide">
      <div class="pill">ğŸ‘‘ Ø£Ù†Øª Ø§Ù„Ù…Ø¶ÙŠÙ</div>
      <h2>Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©:</h2>
      <div class="code" id="lobbyCode">0000</div>
      <div class="players">
        <div style="font-weight:bold; margin-bottom:10px;">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ©: <span id="pCount">0</span></div>
        <div id="pList"></div>
      </div>
      <button type="button" id="startBtn">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¢Ù†</button>
      <button type="button" id="closeBtn" class="btn-grey">âŒ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©</button>
      <div id="lobbyErr" class="status"></div>
    </div>

    <div id="waiting" class="hide">
      <div class="pill" id="waitLabel">Ù„Ø§Ø¹Ø¨</div>
      <div class="roleBox waiting">
        <div>ğŸ‘¥ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</div>
        <div style="font-size:16px; margin-top:10px; color:#666;" id="waitingPlayers">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: 1</div>
      </div>
      <div id="waitErr" class="status"></div>
    </div>

    <div id="game" class="hide">
      <div class="pill" id="gameLabel">Ù„Ø§Ø¹Ø¨</div>
      <div class="roleBox" id="role">
        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±...
      </div>
      <div class="timer" id="timer">5:00</div>
      <div id="hostBtns" class="hide">
        <button type="button" id="endBtn">â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        <button type="button" id="newBtn" class="btn-grey">ğŸ”„ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
      <div id="gameErr" class="status"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ========== SUPABASE CONFIGURATION ==========
    // THESE ARE YOUR CREDENTIALS FROM YOUR SUPABASE PROJECT
    const SUPABASE_URL = "https://cpegnfupiqdgmqsguyed.supabase.co";
    // GET YOUR ANON KEY FROM: Supabase â†’ Settings â†’ API â†’ anon/public key
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwZWduZnVwaXFkZ21xc2d1eWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI4NTA5ODMsImV4cCI6MjA0ODQyNjk4M30.zHRNKkZ5Lly4q4fRZQzT5iWTtq67j3JNkaf3-_W8BkI";
    
    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // ========== GAME STATE ==========
    let currentRoomCode = null;
    let playerId = null;
    let playerNumber = null;
    let isHost = false;
    let pollInterval = null;
    let timerInterval = null;
    let currentWord = null;
    
    // ========== DOM ELEMENTS ==========
    const screens = {
      menu: document.getElementById("menu"),
      create: document.getElementById("create"),
      join: document.getElementById("join"),
      lobby: document.getElementById("lobby"),
      waiting: document.getElementById("waiting"),
      game: document.getElementById("game")
    };
    
    const connectionInfo = document.getElementById("connectionInfo");

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Test connection to Supabase
        const { data, error } = await supabase.from('words').select('text').limit(1);
        
        if (error) {
          console.error("Supabase connection error:", error);
          connectionInfo.innerHTML = "âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­ API.";
          connectionInfo.style.background = "#f8d7da";
          connectionInfo.style.borderColor = "#f5c6cb";
          connectionInfo.style.color = "#721c24";
          
          // Try to create tables if they don't exist
          await createTables();
        } else {
          console.log("âœ… Connected to Supabase! Words found:", data.length);
          connectionInfo.innerHTML = `âœ… Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ${data.length} ÙƒÙ„Ù…Ø© Ø¬Ø§Ù‡Ø²Ø©`;
          connectionInfo.style.background = "#d4edda";
          connectionInfo.style.borderColor = "#c3e6cb";
          connectionInfo.style.color = "#155724";
        }
      } catch (error) {
        console.error("Initialization error:", error);
        connectionInfo.innerHTML = "âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…ÙØªØ§Ø­ API";
      }
      
      setupEventListeners();
      restoreSession();
    });

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      document.getElementById("createBtn").addEventListener("click", showCreateScreen);
      document.getElementById("joinBtn").addEventListener("click", showJoinScreen);
      document.getElementById("generateBtn").addEventListener("click", createRoom);
      document.getElementById("joinNowBtn").addEventListener("click", joinRoom);
      document.getElementById("backFromCreate").addEventListener("click", goBackToMenu);
      document.getElementById("backFromJoin").addEventListener("click", goBackToMenu);
      document.getElementById("startBtn").addEventListener("click", startGame);
      document.getElementById("closeBtn").addEventListener("click", closeRoom);
      document.getElementById("endBtn").addEventListener("click", endRound);
      document.getElementById("newBtn").addEventListener("click", newRound);
      
      document.getElementById("codeInput").addEventListener("input", function(e) {
        this.value = this.value.replace(/\D/g, '').slice(0, 4);
      });
    }

    // ========== SCREEN MANAGEMENT ==========
    function hideAllScreens() {
      Object.values(screens).forEach(screen => screen.classList.add("hide"));
    }

    function showCreateScreen() {
      hideAllScreens();
      screens.create.classList.remove("hide");
      document.getElementById("createErr").textContent = "";
    }

    function showJoinScreen() {
      hideAllScreens();
      screens.join.classList.remove("hide");
      document.getElementById("codeInput").focus();
      document.getElementById("joinErr").textContent = "";
    }

    function goBackToMenu() {
      if (pollInterval) clearInterval(pollInterval);
      if (timerInterval) clearInterval(timerInterval);
      hideAllScreens();
      screens.menu.classList.remove("hide");
    }

    // ========== DATABASE FUNCTIONS ==========
    async function createTables() {
      try {
        // Create rooms table if it doesn't exist
        const { error: roomsError } = await supabase.from('rooms').select('*').limit(1);
        
        if (roomsError && roomsError.message.includes("does not exist")) {
          console.log("Creating tables...");
          
          // You need to run this SQL in your Supabase SQL Editor:
          const setupSQL = `
            -- Create rooms table
            CREATE TABLE IF NOT EXISTS rooms (
              code TEXT PRIMARY KEY,
              status TEXT DEFAULT 'open',
              state TEXT DEFAULT 'waiting',
              word TEXT,
              spy_player_id TEXT,
              imposters TEXT[],
              host_player_id TEXT,
              started_at TIMESTAMPTZ,
              created_at TIMESTAMPTZ DEFAULT NOW()
            );

            -- Create players table
            CREATE TABLE IF NOT EXISTS players (
              id BIGSERIAL PRIMARY KEY,
              room_code TEXT REFERENCES rooms(code) ON DELETE CASCADE,
              player_id TEXT NOT NULL,
              player_num INTEGER NOT NULL,
              joined_at TIMESTAMPTZ DEFAULT NOW(),
              UNIQUE(room_code, player_id),
              UNIQUE(room_code, player_num)
            );

            -- Enable RLS
            ALTER TABLE rooms ENABLE ROW LEVEL SECURITY;
            ALTER TABLE players ENABLE ROW LEVEL SECURITY;

            -- Create policies
            CREATE POLICY "Anyone can view rooms" ON rooms FOR SELECT USING (true);
            CREATE POLICY "Anyone can insert rooms" ON rooms FOR INSERT WITH CHECK (true);
            CREATE POLICY "Anyone can update rooms" ON rooms FOR UPDATE USING (true);
            
            CREATE POLICY "Anyone can view players" ON players FOR SELECT USING (true);
            CREATE POLICY "Anyone can insert players" ON players FOR INSERT WITH CHECK (true);
            CREATE POLICY "Anyone can delete players" ON players FOR DELETE USING (true);
          `;
          
          alert("âš ï¸ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.\n\nØ§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Supabase â†’ SQL Editor ÙˆØ£Ø´ØºÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯:\n\n" + setupSQL);
          return false;
        }
        return true;
      } catch (error) {
        console.error("Table creation error:", error);
        return false;
      }
    }

    async function createRoom() {
      const errorElement = document.getElementById("createErr");
      errorElement.textContent = "";
      
      try {
        // Generate unique player ID
        playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // Generate unique 4-digit room code
        let roomCode;
        let isUnique = false;
        
        while (!isUnique) {
          roomCode = String(Math.floor(1000 + Math.random() * 9000));
          
          // Check if room code already exists
          const { data: existingRoom } = await supabase
            .from('rooms')
            .select('code')
            .eq('code', roomCode)
            .maybeSingle();
          
          if (!existingRoom) {
            isUnique = true;
          }
        }
        
        currentRoomCode = roomCode;
        
        console.log("Creating room:", currentRoomCode);

        // Create room in database
        const { error: roomError } = await supabase.from('rooms').insert([{
          code: currentRoomCode,
          status: 'open',
          state: 'waiting',
          host_player_id: playerId,
          created_at: new Date().toISOString()
        }]);

        if (roomError) throw roomError;

        // Add host as first player
        const { error: playerError } = await supabase.from('players').insert([{
          room_code: currentRoomCode,
          player_id: playerId,
          player_num: 1,
          joined_at: new Date().toISOString()
        }]);

        if (playerError) throw playerError;

        playerNumber = 1;
        isHost = true;
        
        // Save to session storage
        sessionStorage.setItem('imposter_room_code', currentRoomCode);
        sessionStorage.setItem('imposter_player_id', playerId);
        sessionStorage.setItem('imposter_player_num', '1');
        sessionStorage.setItem('imposter_is_host', 'true');

        // Show lobby
        document.getElementById("lobbyCode").textContent = currentRoomCode;
        hideAllScreens();
        screens.lobby.classList.remove("hide");
        
        // Start polling for updates
        startPolling();

      } catch (error) {
        console.error("Create room error:", error);
        errorElement.textContent = "âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: " + error.message;
      }
    }

    async function joinRoom() {
      const errorElement = document.getElementById("joinErr");
      errorElement.textContent = "";
      
      try {
        const inputCode = document.getElementById("codeInput").value.trim();
        
        if (!/^\d{4}$/.test(inputCode)) {
          errorElement.textContent = "âš ï¸ Ø£Ø¯Ø®Ù„ 4 Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø©";
          return;
        }
        
        currentRoomCode = inputCode;
        
        console.log("Joining room:", currentRoomCode);

        // Check if room exists and is open
        const { data: room, error: roomError } = await supabase
          .from('rooms')
          .select('*')
          .eq('code', currentRoomCode)
          .maybeSingle();

        if (roomError) throw roomError;
        if (!room) {
          errorElement.textContent = "âŒ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©";
          return;
        }
        if (room.status !== 'open') {
          errorElement.textContent = "âŒ Ø§Ù„ØºØ±ÙØ© Ù…ØºÙ„Ù‚Ø©";
          return;
        }

        // Generate player ID
        playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // Check if already in room
        const { data: existingPlayer } = await supabase
          .from('players')
          .select('player_num')
          .eq('room_code', currentRoomCode)
          .eq('player_id', playerId)
          .maybeSingle();

        if (existingPlayer) {
          playerNumber = existingPlayer.player_num;
        } else {
          // Get all players to find next available number
          const { data: allPlayers } = await supabase
            .from('players')
            .select('player_num')
            .eq('room_code', currentRoomCode);

          const usedNumbers = new Set(allPlayers.map(p => p.player_num));
          let nextNumber = 1;
          while (usedNumbers.has(nextNumber)) nextNumber++;

          // Add player to database
          const { error: addError } = await supabase.from('players').insert([{
            room_code: currentRoomCode,
            player_id: playerId,
            player_num: nextNumber,
            joined_at: new Date().toISOString()
          }]);

          if (addError) throw addError;
          playerNumber = nextNumber;
        }

        isHost = false;
        
        // Save to session storage
        sessionStorage.setItem('imposter_room_code', currentRoomCode);
        sessionStorage.setItem('imposter_player_id', playerId);
        sessionStorage.setItem('imposter_player_num', playerNumber.toString());
        sessionStorage.setItem('imposter_is_host', 'false');

        // Show waiting screen
        document.getElementById("waitLabel").textContent = `Ù„Ø§Ø¹Ø¨ ${playerNumber}`;
        hideAllScreens();
        screens.waiting.classList.remove("hide");
        
        // Start polling
        startPolling();

      } catch (error) {
        console.error("Join room error:", error);
        errorElement.textContent = "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: " + error.message;
      }
    }

    async function startGame() {
      const errorElement = document.getElementById("lobbyErr");
      errorElement.textContent = "";
      
      try {
        // Get all players in room
        const { data: players, error: playersError } = await supabase
          .from('players')
          .select('player_id')
          .eq('room_code', currentRoomCode);

        if (playersError) throw playersError;
        if (!players || players.length < 2) {
          errorElement.textContent = "âš ï¸ ÙŠØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 2";
          return;
        }

        console.log("Starting game with", players.length, "players");

        // Get random word from YOUR Arabic words table
        const { data: words, error: wordsError } = await supabase
          .from('words')
          .select('text');

        if (wordsError) throw wordsError;
        if (!words || words.length === 0) {
          errorElement.textContent = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
          return;
        }

        const randomWord = words[Math.floor(Math.random() * words.length)].text;
        currentWord = randomWord;
        
        console.log("Selected word:", currentWord);

        // Determine number of imposters
        const playerCount = players.length;
        const imposterCount = playerCount >= 5 ? 2 : 1;
        
        // Select imposters randomly
        const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);
        const imposters = shuffledPlayers.slice(0, imposterCount).map(p => p.player_id);

        // Update room to playing state
        const { error: updateError } = await supabase
          .from('rooms')
          .update({
            state: 'playing',
            word: currentWord,
            spy_player_id: imposters[0],
            imposters: imposters,
            started_at: new Date().toISOString()
          })
          .eq('code', currentRoomCode);

        if (updateError) throw updateError;

        console.log("Game started successfully!");

      } catch (error) {
        console.error("Start game error:", error);
        errorElement.textContent = "âŒ ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©: " + error.message;
      }
    }

    // ========== POLLING FOR UPDATES ==========
    function startPolling() {
      if (pollInterval) clearInterval(pollInterval);
      
      pollInterval = setInterval(async () => {
        try {
          if (!currentRoomCode) return;

          // Get room status
          const { data: room, error: roomError } = await supabase
            .from('rooms')
            .select('*')
            .eq('code', currentRoomCode)
            .maybeSingle();

          if (roomError) throw roomError;
          
          if (!room || room.status !== 'open') {
            clearInterval(pollInterval);
            alert("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©");
            goBackToMenu();
            return;
          }

          // Get players in room
          const { data: players } = await supabase
            .from('players')
            .select('player_id, player_num')
            .eq('room_code', currentRoomCode)
            .order('player_num');

          // Update lobby or waiting screen
          if (isHost && room.state === 'waiting') {
            updateLobbyDisplay(players);
          } else if (!isHost && room.state === 'waiting') {
            updateWaitingDisplay(players);
          }

          // Handle game state
          if (room.state === 'playing' && room.started_at) {
            showGameScreen(room);
          } else if (room.state === 'ended') {
            if (isHost) {
              hideAllScreens();
              screens.lobby.classList.remove("hide");
              document.getElementById("lobbyErr").textContent = "ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©";
              updateLobbyDisplay(players);
            } else {
              hideAllScreens();
              screens.waiting.classList.remove("hide");
              document.getElementById("waitErr").textContent = "ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø© - Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ";
            }
          }

        } catch (error) {
          console.error("Polling error:", error);
        }
      }, 2000); // Poll every 2 seconds
    }

    function updateLobbyDisplay(players) {
      if (!players) return;
      
      document.getElementById("pCount").textContent = players.length;
      
      const playersList = document.getElementById("pList");
      playersList.innerHTML = players.map(player => `
        <div class="player">
          <span>Ù„Ø§Ø¹Ø¨ ${player.player_num}</span>
          <div>
            ${player.player_id === playerId ? '<span class="player-status player-you">Ø£Ù†Øª</span>' : ''}
            ${player.player_id === playerId ? '<span class="player-status player-host">Ø§Ù„Ù…Ø¶ÙŠÙ</span>' : ''}
          </div>
        </div>
      `).join('');
    }

    function updateWaitingDisplay(players) {
      if (!players) return;
      document.getElementById("waitingPlayers").textContent = `Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: ${players.length}`;
    }

    function showGameScreen(room) {
      hideAllScreens();
      screens.game.classList.remove("hide");

      const isImposter = room.imposters && room.imposters.includes(playerId);
      
      document.getElementById("gameLabel").textContent = `Ù„Ø§Ø¹Ø¨ ${playerNumber}`;
      
      const roleBox = document.getElementById("role");
      
      if (isImposter) {
        roleBox.className = "roleBox spy";
        roleBox.innerHTML = `
          ğŸ•µï¸<br><br>
          <strong>Ø£Ù†Øª Ø§Ù„Ù…Ø®Ø¨Ø±!</strong><br><br>
          Ø­Ø§ÙˆÙ„ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙƒÙ„Ù…Ø©<br>
          Ø¯ÙˆÙ† Ø£Ù† ÙŠØ¹Ø±Ù Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†<br><br>
          ğŸ­
        `;
      } else {
        roleBox.className = "roleBox normal";
        roleBox.innerHTML = `
          Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ© Ù‡ÙŠ:<br><br>
          <div class="word">${escapeHtml(room.word || "Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...")}</div><br>
          Ø­Ø§ÙˆÙ„ ÙˆØµÙÙ‡Ø§ Ø¯ÙˆÙ† Ø°ÙƒØ± Ø§Ø³Ù…Ù‡Ø§!
        `;
      }

      // Show host controls if host
      if (isHost) {
        document.getElementById("hostBtns").classList.remove("hide");
      }

      // Start timer
      startTimer(room.started_at);
    }

    function startTimer(startTime) {
      if (timerInterval) clearInterval(timerInterval);
      
      const start = new Date(startTime).getTime();
      
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - start) / 1000);
        const remaining = Math.max(0, 300 - elapsed); // 5 minutes
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        
        document.getElementById("timer").textContent = 
          `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (remaining <= 0) {
          clearInterval(timerInterval);
          document.getElementById("timer").textContent = "â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!";
        }
      }, 1000);
    }

    // ========== GAME CONTROL FUNCTIONS ==========
    async function endRound() {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ")) return;
      
      try {
        await supabase
          .from('rooms')
          .update({ state: 'ended' })
          .eq('code', currentRoomCode);
      } catch (error) {
        console.error("End round error:", error);
      }
    }

    async function newRound() {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ")) return;
      
      try {
        await supabase
          .from('rooms')
          .update({
            state: 'waiting',
            word: null,
            spy_player_id: null,
            imposters: null,
            started_at: null
          })
          .eq('code', currentRoomCode);
      } catch (error) {
        console.error("New round error:", error);
      }
    }

    async function closeRoom() {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©ØŸ Ø³ÙŠØªÙ… ÙØµÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.")) return;
      
      try {
        await supabase
          .from('rooms')
          .update({ status: 'closed' })
          .eq('code', currentRoomCode);
        
        await supabase
          .from('players')
          .delete()
          .eq('room_code', currentRoomCode);
        
        // Clear session
        sessionStorage.clear();
        
        goBackToMenu();
      } catch (error) {
        console.error("Close room error:", error);
      }
    }

    // ========== UTILITY FUNCTIONS ==========
    function restoreSession() {
      const savedCode = sessionStorage.getItem('imposter_room_code');
      const savedPlayerId = sessionStorage.getItem('imposter_player_id');
      const savedPlayerNum = sessionStorage.getItem('imposter_player_num');
      const savedIsHost = sessionStorage.getItem('imposter_is_host');
      
      if (savedCode && savedPlayerId && savedPlayerNum) {
        currentRoomCode = savedCode;
        playerId = savedPlayerId;
        playerNumber = parseInt(savedPlayerNum);
        isHost = savedIsHost === 'true';
        
        console.log("Restored session for player", playerNumber, "in room", currentRoomCode);
        
        if (isHost) {
          document.getElementById("lobbyCode").textContent = currentRoomCode;
          hideAllScreens();
          screens.lobby.classList.remove("hide");
        } else {
          document.getElementById("waitLabel").textContent = `Ù„Ø§Ø¹Ø¨ ${playerNumber}`;
          hideAllScreens();
          screens.waiting.classList.remove("hide");
        }
        
        startPolling();
      }
    }

    function escapeHtml(text) {
      if (!text) return "";
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (pollInterval) clearInterval(pollInterval);
      if (timerInterval) clearInterval(timerInterval);
    });
  </script>
</body>
</html>
