<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Imposter Game</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      background: repeating-linear-gradient(
        45deg,
        #000000,
        #000000 10px,
        #ffffff 10px,
        #ffffff 20px
      );
      min-height:100vh;
      padding:20px;
    }
    .container{
      background:#fff;
      border:5px solid #000000;
      border-radius:15px;
      padding:25px;
      max-width:450px;
      margin:0 auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    h1{ text-align:center; color:#000000; margin-bottom:20px; }
    h2{ color:#000000; margin:15px 0; }
    input, button{ 
      width:100%; 
      padding:15px; 
      margin:10px 0; 
      font-size:18px; 
      border-radius:8px; 
      border:3px solid #000000;
      box-sizing:border-box;
      transition: all 0.3s;
    }
    button{ 
      background:#000000; 
      color:#fff; 
      cursor:pointer; 
      font-weight:bold;
      border:none;
    }
    button:hover{ transform: scale(1.02); }
    button:active{ background:#333333; }
    .btn-grey{ background:#808080; }
    .btn-grey:hover { background:#666666; }
    .hide{ display:none !important; }
    .code{ 
      font-size:70px; 
      text-align:center; 
      font-weight:900; 
      color:#000000; 
      margin:20px 0;
      letter-spacing:8px;
      text-shadow: 2px 2px 0 #ccc;
    }
    .status{ 
      color:#d00; 
      font-weight:bold; 
      margin:10px 0; 
      text-align:center;
      min-height:24px;
    }
    .success { color: #008000; }
    .roleBox{
      padding:30px;
      margin:20px 0;
      border-radius:15px;
      border:5px solid #000000;
      font-size:24px;
      font-weight:900;
      text-align:center;
      min-height:180px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
    }
    .normal{ background:#fff; color:#000000; }
    .spy{ background:#000000; color:#fff; font-size:32px; }
    .waiting{ background:#f5f5f5; color:#666; }
    .word{ font-size:48px; margin-top:15px; color:#000000; }
    .players{ margin:15px 0; }
    .player{ 
      background:#f0f0f0; 
      border:2px solid #000000; 
      padding:12px; 
      margin:8px 0; 
      border-radius:8px;
      font-weight:bold;
    }
    .timer{ 
      font-size:50px; 
      font-weight:900; 
      text-align:center; 
      color:#000000; 
      margin:20px 0;
    }
    .pill{
      display:inline-block;
      padding:8px 15px;
      background:#000000;
      color:#fff;
      border-radius:20px;
      font-weight:bold;
      margin:10px 0;
    }
    input:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    #codeInput {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üïµÔ∏è IMPOSTER GAME</h1>
    <p style="text-align:center; font-size:11px; color:#666; margin-bottom:15px;">BLACK & WHITE STRIPED VERSION</p>

    <div id="menu">
      <button type="button" id="createBtn">CREATE ROOM</button>
      <button type="button" id="joinBtn" class="btn-grey">JOIN ROOM</button>
      <div id="menuErr" class="status"></div>
    </div>

    <div id="create" class="hide">
      <h2>Create Room</h2>
      <button type="button" id="generateBtn">GENERATE CODE</button>
      <button type="button" id="backFromCreate" class="btn-grey">Back</button>
      <div id="createErr" class="status"></div>
    </div>

    <div id="join" class="hide">
      <h2>Join Room</h2>
      <input id="codeInput" type="text" maxlength="4" placeholder="Enter 4-digit code" pattern="\d*" inputmode="numeric">
      <button type="button" id="joinNowBtn">JOIN NOW</button>
      <button type="button" id="backFromJoin" class="btn-grey">Back</button>
      <div id="joinErr" class="status"></div>
    </div>

    <div id="lobby" class="hide">
      <div class="pill">HOST</div>
      <h2>Room Code:</h2>
      <div class="code" id="lobbyCode">0000</div>
      <div class="players">
        <div style="font-weight:bold; margin-bottom:10px;">Players: <span id="pCount">0</span></div>
        <div id="pList"></div>
      </div>
      <button type="button" id="startBtn">START GAME</button>
      <button type="button" id="closeBtn" class="btn-grey">CLOSE ROOM</button>
      <div id="lobbyErr" class="status"></div>
    </div>

    <div id="waiting" class="hide">
      <div class="pill" id="waitLabel">Player</div>
      <div class="roleBox waiting">Waiting for host to start...</div>
      <div id="waitErr" class="status"></div>
    </div>

    <div id="game" class="hide">
      <div class="pill" id="gameLabel">Player</div>
      <div class="roleBox" id="role">Loading...</div>
      <div class="timer" id="timer">5:00</div>
      <div id="hostBtns" class="hide">
        <button type="button" id="endBtn">END ROUND</button>
        <button type="button" id="newBtn" class="btn-grey">NEW ROUND</button>
      </div>
      <div id="gameErr" class="status"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const sb = window.supabase.createClient(
      "https://cpegnfupiqdgmqsguyed.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwZWduZnVwaXFkZ21xc2d1eWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI4NTA5ODMsImV4cCI6MjA0ODQyNjk4M30.zHRNKkZ5Lly4q4fRZQzT5iWTtq67j3JNkaf3-_W8BkI"
    );

    let code = null;
    let pid = null;
    let pnum = null;
    let host = false;
    let poll = null;
    let tmr = null;
    let currentWord = null;

    const sc = {
      menu: document.getElementById("menu"),
      create: document.getElementById("create"),
      join: document.getElementById("join"),
      lobby: document.getElementById("lobby"),
      waiting: document.getElementById("waiting"),
      game: document.getElementById("game")
    };

    // Event Listeners
    document.getElementById("createBtn").addEventListener("click", goCreate);
    document.getElementById("joinBtn").addEventListener("click", goJoin);
    document.getElementById("generateBtn").addEventListener("click", doCreate);
    document.getElementById("joinNowBtn").addEventListener("click", doJoin);
    document.getElementById("backFromCreate").addEventListener("click", goBack);
    document.getElementById("backFromJoin").addEventListener("click", goBack);
    document.getElementById("startBtn").addEventListener("click", doStart);
    document.getElementById("closeBtn").addEventListener("click", doClose);
    document.getElementById("endBtn").addEventListener("click", doEnd);
    document.getElementById("newBtn").addEventListener("click", doNew);

    // Code input formatting
    document.getElementById("codeInput").addEventListener("input", function(e) {
      this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });

    function hideAll() {
      Object.values(sc).forEach(s => s.classList.add("hide"));
    }

    function goCreate() {
      hideAll();
      sc.create.classList.remove("hide");
      document.getElementById("createErr").textContent = "";
    }

    function goJoin() {
      hideAll();
      sc.join.classList.remove("hide");
      document.getElementById("codeInput").focus();
      document.getElementById("joinErr").textContent = "";
    }

    function goBack() {
      if(poll) clearInterval(poll);
      hideAll();
      sc.menu.classList.remove("hide");
    }

    async function doCreate() {
      document.getElementById("createErr").textContent = "";
      try {
        // Generate player ID if not exists
        pid = ss("pid") || ("p_" + rand());
        ss("pid", pid);

        // Generate 4-digit code
        code = String(Math.floor(1000 + Math.random() * 9000));
        
        console.log("Creating room with code:", code);

        // Create room
        const {error: re} = await sb.from("rooms").insert([{
          code: code,
          status: "open",
          state: "waiting",
          host_player_id: pid,
          created_at: new Date().toISOString()
        }]);
        
        if(re) {
          console.error("Room creation error:", re);
          throw re;
        }

        // Add host as player 1
        const {error: pe} = await sb.from("players").insert([{
          room_code: code,
          player_id: pid,
          player_num: 1,
          joined_at: new Date().toISOString()
        }]);
        
        if(pe) {
          console.error("Player creation error:", pe);
          throw pe;
        }

        pnum = 1;
        host = true;
        ss("code", code);
        ss("pnum", "1");
        ss("host", "1");

        document.getElementById("lobbyCode").textContent = code;
        hideAll();
        sc.lobby.classList.remove("hide");
        doPoll();

      } catch(e) {
        console.error("Create error:", e);
        document.getElementById("createErr").textContent = e.message || "Failed to create room";
      }
    }

    async function doJoin() {
      document.getElementById("joinErr").textContent = "";
      try {
        code = document.getElementById("codeInput").value.trim();
        
        if(!/^\d{4}$/.test(code)) {
          document.getElementById("joinErr").textContent = "Enter 4 digits";
          return;
        }

        console.log("Joining room:", code);

        // Generate player ID if not exists
        pid = ss("pid") || ("p_" + rand());
        ss("pid", pid);

        // Check if room exists and is open
        const {data: rm, error: re} = await sb.from("rooms")
          .select("*")
          .eq("code", code)
          .maybeSingle();
          
        if(re) throw re;
        
        if(!rm) {
          document.getElementById("joinErr").textContent = "Room not found";
          return;
        }
        
        if(rm.status !== "open") {
          document.getElementById("joinErr").textContent = "Room is closed";
          return;
        }

        // Check if player already exists in this room
        const {data: ex} = await sb.from("players")
          .select("player_num")
          .eq("room_code", code)
          .eq("player_id", pid)
          .maybeSingle();

        if(ex) {
          pnum = ex.player_num;
          console.log("Existing player, number:", pnum);
        } else {
          // Get all players to determine next number
          const {data: pls} = await sb.from("players")
            .select("player_num")
            .eq("room_code", code);
            
          const used = new Set((pls || []).map(p => p.player_num));
          let n = 1;
          while(used.has(n)) n++;

          // Add new player
          const {error: ae} = await sb.from("players").insert([{
            room_code: code,
            player_id: pid,
            player_num: n,
            joined_at: new Date().toISOString()
          }]);
          
          if(ae) throw ae;
          pnum = n;
          console.log("New player, number:", pnum);
        }

        host = false;
        ss("code", code);
        ss("pnum", String(pnum));
        ss("host", "0");

        document.getElementById("waitLabel").textContent = "Player " + pnum;
        hideAll();
        sc.waiting.classList.remove("hide");
        doPoll();

      } catch(e) {
        console.error("Join error:", e);
        document.getElementById("joinErr").textContent = e.message || "Failed to join room";
      }
    }

    async function doStart() {
      document.getElementById("lobbyErr").textContent = "";
      try {
        // Get all players
        const {data: pls} = await sb.from("players")
          .select("player_id")
          .eq("room_code", code);
          
        if(!pls || pls.length < 2) {
          document.getElementById("lobbyErr").textContent = "Need at least 2 players";
          return;
        }

        console.log("Starting game with players:", pls.length);

        // Get random word from Supabase
        const {data: wds, error: wdErr} = await sb.from("words").select("text");
        
        if(wdErr) throw wdErr;
        if(!wds || wds.length === 0) {
          document.getElementById("lobbyErr").textContent = "No words available";
          return;
        }
        
        const wordData = wds[Math.floor(Math.random() * wds.length)];
        currentWord = wordData.text;
        console.log("Selected word:", currentWord);

        // Determine number of imposters based on player count
        const playerCount = pls.length;
        const imposterCount = playerCount >= 5 ? 2 : 1;
        console.log(`Players: ${playerCount}, Imposters: ${imposterCount}`);

        // Shuffle players and select imposters
        const shuffledPlayers = [...pls].sort(() => Math.random() - 0.5);
        const imposters = shuffledPlayers.slice(0, imposterCount).map(p => p.player_id);
        
        console.log("Imposters selected:", imposters);

        // Update room state
        const {error: ue} = await sb.from("rooms").update({
          state: "playing",
          word: currentWord,
          spy_player_id: imposters[0],
          imposters: imposters,
          started_at: new Date().toISOString()
        }).eq("code", code);
        
        if(ue) throw ue;

        console.log("Game started successfully");

      } catch(e) {
        console.error("Start error:", e);
        document.getElementById("lobbyErr").textContent = e.message || "Failed to start game";
      }
    }

    async function doEnd() {
      if(!confirm("End round?")) return;
      
      try {
        await sb.from("rooms").update({state: "ended"}).eq("code", code);
        console.log("Round ended");
      } catch(e) {
        console.error("End round error:", e);
      }
    }

    async function doNew() {
      if(!confirm("Start new round?")) return;
      
      try {
        await sb.from("rooms").update({
          state: "waiting",
          word: null,
          spy_player_id: null,
          imposters: null,
          started_at: null
        }).eq("code", code);
        
        console.log("New round started");
        
        // Update local display
        hideAll();
        sc.lobby.classList.remove("hide");
        document.getElementById("lobbyErr").textContent = "New round starting...";
        document.getElementById("lobbyErr").className = "status success";
        
      } catch(e) {
        console.error("New round error:", e);
      }
    }

    async function doClose() {
      if(!confirm("Close room? All players will be disconnected.")) return;
      
      try {
        await sb.from("rooms").update({status: "closed"}).eq("code", code);
        await sb.from("players").delete().eq("room_code", code);
        
        if(poll) clearInterval(poll);
        goBack();
      } catch(e) {
        console.error("Close room error:", e);
      }
    }

    function doPoll() {
      if(poll) clearInterval(poll);
      
      poll = setInterval(async () => {
        try {
          if(!code) return;
          
          const {data: rm, error: re} = await sb.from("rooms")
            .select("*")
            .eq("code", code)
            .maybeSingle();
            
          if(re) throw re;
          
          if(!rm || rm.status !== "open") {
            if(poll) clearInterval(poll);
            alert("Room has been closed");
            goBack();
            return;
          }

          // Update lobby if host
          if(host && rm.state === "waiting") {
            const {data: pls} = await sb.from("players")
              .select("player_num, player_id")
              .eq("room_code", code)
              .order("player_num");
              
            if(pls) {
              document.getElementById("pCount").textContent = pls.length;
              document.getElementById("pList").innerHTML = pls
                .map(p => `<div class="player">Player ${p.player_num}${p.player_id === pid ? ' (YOU - HOST)' : ''}</div>`)
                .join("");
            }
          }

          // Handle game state changes
          if(rm.state === "playing" && rm.started_at) {
            showGame(rm);
          } else if(rm.state === "ended") {
            if(host) {
              hideAll();
              sc.lobby.classList.remove("hide");
              document.getElementById("lobbyErr").textContent = "Round ended. Click 'NEW ROUND' to start again.";
              document.getElementById("lobbyErr").className = "status";
            } else {
              hideAll();
              sc.waiting.classList.remove("hide");
              document.getElementById("waitErr").textContent = "Round ended. Waiting for host...";
            }
          }

        } catch(e) {
          console.error("Poll error:", e);
        }
      }, 2000);
    }

    function showGame(rm) {
      hideAll();
      sc.game.classList.remove("hide");

      const imps = rm.imposters || (rm.spy_player_id ? [rm.spy_player_id] : []);
      const isImp = imps.includes(pid);

      document.getElementById("gameLabel").textContent = "Player " + pnum;
      const rb = document.getElementById("role");

      if(isImp) {
        rb.className = "roleBox spy";
        rb.innerHTML = "üïµÔ∏è<br><br>YOU ARE THE<br>IMPOSTER<br><br>üé≠";
      } else {
        rb.className = "roleBox normal";
        rb.innerHTML = `YOUR WORD IS:<div class="word">${esc(rm.word || "Unknown")}</div>`;
      }

      // Show host buttons if host
      if(host) {
        document.getElementById("hostBtns").classList.remove("hide");
      }

      // Start timer
      const start = new Date(rm.started_at).getTime();
      if(tmr) clearInterval(tmr);
      
      tmr = setInterval(() => {
        const elapsed = Math.floor((Date.now() - start) / 1000);
        const remaining = Math.max(0, 300 - elapsed); // 5 minutes
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        
        document.getElementById("timer").textContent = remaining > 0
          ? `${minutes}:${String(seconds).padStart(2, "0")}`
          : "TIME UP ‚è∞";
      }, 1000);
    }

    function ss(k, v) {
      if(v === undefined) return sessionStorage.getItem(k);
      sessionStorage.setItem(k, v);
    }

    function rand() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function esc(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    // Initialize on page load
    window.addEventListener("load", () => {
      const c = ss("code");
      const n = ss("pnum");
      const p = ss("pid");
      const h = ss("host") === "1";

      if(c && n && p) {
        code = c;
        pnum = parseInt(n);
        pid = p;
        host = h;

        console.log("Restored session:", { code, pnum, pid, host });

        if(host) {
          document.getElementById("lobbyCode").textContent = code;
          hideAll();
          sc.lobby.classList.remove("hide");
        } else {
          document.getElementById("waitLabel").textContent = "Player " + pnum;
          hideAll();
          sc.waiting.classList.remove("hide");
        }
        doPoll();
      }
    });

    window.addEventListener("beforeunload", () => {
      if(poll) clearInterval(poll);
      if(tmr) clearInterval(tmr);
    });
  </script>
</body>
</html>
