<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ğŸ•µï¸</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
    }
    .container{
      background:#fff;border-radius:20px;padding:28px;max-width:420px;width:100%;
      box-shadow:0 10px 40px rgba(0,0,0,.25);
    }
    h1{text-align:center;color:#667eea;margin-bottom:18px;font-size:28px}
    label{display:block;margin:12px 0 8px;font-weight:800;color:#333}
    input{
      width:100%;padding:14px;border:2px solid #ddd;border-radius:12px;font-size:22px;
      text-align:center;font-weight:900
    }
    button{
      width:100%;padding:16px;margin-top:12px;border:0;border-radius:12px;
      background:#667eea;color:#fff;font-size:20px;font-weight:900;cursor:pointer
    }
    button:hover{opacity:.92}
    .status{margin-top:10px;text-align:center;color:#666;font-weight:700}
    .hidden{display:none}
    .player-label{text-align:center;font-size:18px;color:#667eea;font-weight:900;margin:6px 0 12px}
    .role{
      text-align:center;padding:22px;border-radius:16px;font-weight:900;min-height:160px;
      display:flex;flex-direction:column;align-items:center;justify-content:center
    }
    .role.waiting{background:#f8f9fa;color:#555;border:2px solid #eee}
    .role.normal{background:#d4edda;color:#155724;border:3px solid #28a745}
    .role.spy{background:#f8d7da;color:#721c24;border:3px solid #dc3545;font-size:30px}
    .word{font-size:34px;margin-top:10px}
    .timer{text-align:center;font-size:40px;color:#764ba2;font-weight:900;margin-top:14px}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø§Ø³ÙˆØ³</h1>

    <div id="joinScreen">
      <label>Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© (Ù¤ Ø£Ø±Ù‚Ø§Ù…)</label>
      <input id="roomCode" type="tel" inputmode="numeric" maxlength="4" placeholder="1234">
      <button id="joinBtn">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
      <div class="status" id="status"></div>
    </div>

    <div id="gameScreen" class="hidden">
      <div class="player-label" id="playerLabel"></div>
      <div class="role waiting" id="roleBox">â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©...</div>
      <div class="timer" id="timer"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://cpegnfupiqdgmqsguyed.supabase.co";
    const SUPABASE_KEY = "sb_publishable_WKaLUCc9WeXbEcgDfMf1KQ_NKYoTVuU";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const $ = (id) => document.getElementById(id);

    let roomCode = "";
    let playerUid = "";
    let playerNum = null;

    let pollTimer = null;
    let timerInterval = null;
    let cachedRoundStart = null;

    $("joinBtn").addEventListener("click", joinRoom);

    function isValid4DigitCode(code){ return /^\d{4}$/.test(code); }

    function getOrCreatePlayerUid(){
      let uid = localStorage.getItem("spy_player_uid");
      if (!uid) {
        uid = "p_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        localStorage.setItem("spy_player_uid", uid);
      }
      return uid;
    }

    async function joinRoom(){
      roomCode = $("roomCode").value.trim();
      if (!isValid4DigitCode(roomCode)) return alert("Ø§ÙƒØªØ¨ Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·");

      playerUid = getOrCreatePlayerUid();

      // Check room exists
      const { data: room, error: rErr } = await supabase
        .from("rooms")
        .select("code,state")
        .eq("code", roomCode)
        .single();

      if (rErr || !room) {
        $("status").textContent = "Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©";
        return;
      }

      // Ensure player row exists; assign player_num safely with retry
      let attempts = 0;
      while (attempts < 6) {
        attempts++;

        // If already joined, fetch your number
        const { data: existing } = await supabase
          .from("players")
          .select("player_num")
          .eq("room_code", roomCode)
          .eq("player_uid", playerUid)
          .maybeSingle();

        if (existing && existing.player_num) {
          playerNum = existing.player_num;
          break;
        }

        // Count current players to suggest next number
        const { data: list, error: lErr } = await supabase
          .from("players")
          .select("player_num")
          .eq("room_code", roomCode);

        if (lErr) {
          console.error(lErr);
          $("status").textContent = "ØµØ§Ø± Ø®Ø·Ø£.. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©";
          return;
        }

        const nextNum = (list?.length || 0) + 1;

        const { error: iErr } = await supabase
          .from("players")
          .insert([{ room_code: roomCode, player_uid: playerUid, player_num: nextNum }]);

        if (!iErr) {
          playerNum = nextNum;
          break;
        }

        // unique violation on player_num or (room_code, player_uid) -> retry
        if (iErr.code === "23505") continue;

        console.error(iErr);
        $("status").textContent = "ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù….. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©";
        return;
      }

      if (!playerNum) {
        $("status").textContent = "Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ØªØ£Ø®Ø± Ø¨Ø³Ø¨Ø¨ Ø¶ØºØ·.. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©";
        return;
      }

      sessionStorage.setItem("spy_room_code", roomCode);
      sessionStorage.setItem("spy_player_num", String(playerNum));

      showGameScreen();
      startPolling();
    }

    function showGameScreen(){
      $("joinScreen").classList.add("hidden");
      $("gameScreen").classList.remove("hidden");
      $("playerLabel").textContent = `Ø£Ù†Øª: Ù„Ø§Ø¹Ø¨ ${toArabicDigits(playerNum)}`;
    }

    function toArabicDigits(num){
      const ar = ['Ù ','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©'];
      return String(num).split('').map(d => ar[parseInt(d,10)] ?? d).join('');
    }

    function clearTimer(){
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      $("timer").textContent = "";
      cachedRoundStart = null;
    }

    function startTimer(isoStart){
      cachedRoundStart = isoStart;
      const startTime = new Date(isoStart).getTime();
      const duration = 5 * 60; // 5 minutes

      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = Math.max(0, duration - elapsed);
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        $("timer").textContent = remaining > 0
          ? `${toArabicDigits(mins)}:${toArabicDigits(String(secs).padStart(2,'0'))}`
          : "â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª";
      }, 1000);
    }

    function showWaiting(){
      $("roleBox").className = "role waiting";
      $("roleBox").innerHTML = "â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©...";
      clearTimer();
    }

    function showSpy(){
      $("roleBox").className = "role spy";
      $("roleBox").innerHTML = "ğŸ•µï¸<br>Ø£Ù†Øª Ø§Ù„Ø¬Ø§Ø³ÙˆØ³";
    }

    function showWord(wordText){
      $("roleBox").className = "role normal";
      $("roleBox").innerHTML = `Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©:<div class="word">${wordText}</div>`;
    }

    async function startPolling(){
      if (pollTimer) clearInterval(pollTimer);

      pollTimer = setInterval(async () => {
        // Fetch room + joined word text
        const { data: room, error } = await supabase
          .from("rooms")
          .select("state, spy_player_uid, round_started_at, word:words(text)")
          .eq("code", roomCode)
          .single();

        if (error || !room) return;

        if (room.state !== "playing") {
          showWaiting();
          return;
        }

        // playing
        if (room.spy_player_uid === playerUid) {
          showSpy();
        } else {
          const w = room.word && room.word.text ? room.word.text : "â€”";
          showWord(w);
        }

        if (room.round_started_at && (!cachedRoundStart || cachedRoundStart !== room.round_started_at)) {
          clearTimer();
          startTimer(room.round_started_at);
        }

      }, 1100);
    }

    window.onload = () => {
      const savedRoom = sessionStorage.getItem("spy_room_code");
      const savedNum = sessionStorage.getItem("spy_player_num");
      const uid = localStorage.getItem("spy_player_uid");

      if (savedRoom && savedNum && uid) {
        roomCode = savedRoom;
        playerNum = parseInt(savedNum, 10);
        playerUid = uid;
        showGameScreen();
        startPolling();
      }
    };

    window.addEventListener("beforeunload", () => {
      if (pollTimer) clearInterval(pollTimer);
      if (timerInterval) clearInterval(timerInterval);
    });
  </script>
</body>
</html>
