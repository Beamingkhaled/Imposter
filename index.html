<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø± - ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Arial, sans-serif;
      background: repeating-linear-gradient(45deg, #22c55e, #22c55e 10px, #ffffff 10px, #ffffff 20px);
      min-height:100vh;
      padding:20px;
      direction: rtl;
    }
    .container {
      background:#fff;
      border:5px solid #22c55e;
      border-radius:15px;
      padding:25px;
      max-width:450px;
      margin:0 auto;
    }
    h1 { text-align:center; color:#22c55e; margin-bottom:20px; }
    button {
      width:100%;
      padding:15px;
      margin:10px 0;
      font-size:18px;
      border-radius:8px;
      border:none;
      background:#22c55e;
      color:white;
      cursor:pointer;
      font-weight:bold;
    }
    button:hover { opacity:0.9; }
    .btn-grey { background:#666; }
    .hide { display:none; }
    .code {
      font-size:80px;
      text-align:center;
      font-weight:900;
      color:#22c55e;
      margin:20px 0;
      letter-spacing:10px;
    }
    .status {
      color:red;
      text-align:center;
      margin:10px 0;
      min-height:20px;
    }
    input {
      width:100%;
      padding:15px;
      font-size:24px;
      text-align:center;
      border:3px solid #22c55e;
      border-radius:8px;
      margin:10px 0;
    }
    .roleBox {
      padding:20px;
      margin:20px 0;
      border:5px solid #22c55e;
      border-radius:15px;
      text-align:center;
      font-size:24px;
      min-height:150px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
    }
    .spy {
      background:#22c55e;
      color:white;
    }
    .word {
      font-size:48px;
      color:#22c55e;
      margin-top:10px;
      font-weight:bold;
    }
    .player {
      background:#f0f0f0;
      padding:10px;
      margin:5px 0;
      border-radius:8px;
      border:2px solid #22c55e;
    }
    .connection-status {
      background:#e3f2fd;
      padding:10px;
      border-radius:8px;
      margin-bottom:15px;
      text-align:center;
      font-size:14px;
      border:2px solid #bbdefb;
    }
    .connected { color:green; }
    .disconnected { color:red; }
  </style>
</head>
<body>
  <div class="container">
    <div class="connection-status" id="connectionStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
    
    <h1>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø¨Ø±</h1>
    
    <!-- MENU -->
    <div id="menu">
      <button onclick="showCreate()">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
      <button onclick="showJoin()" class="btn-grey">Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</button>
    </div>
    
    <!-- CREATE -->
    <div id="create" class="hide">
      <h2>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
      <button onclick="createRoom()">ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</button>
      <button onclick="goBack()" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="createErr" class="status"></div>
    </div>
    
    <!-- JOIN -->
    <div id="join" class="hide">
      <h2>Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</h2>
      <input id="roomCodeInput" type="text" maxlength="4" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²" pattern="\d*">
      <button onclick="joinRoom()">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</button>
      <button onclick="goBack()" class="btn-grey">Ø±Ø¬ÙˆØ¹</button>
      <div id="joinErr" class="status"></div>
    </div>
    
    <!-- LOBBY -->
    <div id="lobby" class="hide">
      <h2>ğŸ‘‘ Ø£Ù†Øª Ø§Ù„Ù…Ø¶ÙŠÙ</h2>
      <div class="code" id="roomCodeDisplay">0000</div>
      <div id="playersList">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</div>
      <button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      <button onclick="leaveRoom()" class="btn-grey">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©</button>
    </div>
    
    <!-- WAITING -->
    <div id="waiting" class="hide">
      <h2 id="playerTitle">Ù„Ø§Ø¹Ø¨</h2>
      <div class="roleBox">
        Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...
        <div style="margin-top:10px; font-size:16px;" id="playerCount">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
      <button onclick="leaveRoom()" class="btn-grey">ØªØ±Ùƒ Ø§Ù„ØºØ±ÙØ©</button>
    </div>
    
    <!-- GAME -->
    <div id="game" class="hide">
      <h2 id="gamePlayerTitle">Ù„Ø§Ø¹Ø¨</h2>
      <div class="roleBox" id="roleBox">
        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±...
      </div>
      <div id="hostControls" class="hide">
        <button onclick="endGame()">Ø§Ù†Ù‡ÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        <button onclick="newGame()" class="btn-grey">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
      <button onclick="leaveRoom()" class="btn-grey">ØªØ±Ùƒ Ø§Ù„ØºØ±ÙØ©</button>
    </div>
  </div>

  <script>
    // ========== GAME STATE ==========
    let roomCode = '';
    let playerId = '';
    let playerNumber = 0;
    let isHost = false;
    let pollInterval = null;
    
    // ========== SUPABASE SETUP ==========
    let supabase = null;
    
    // Initialize Supabase
    async function initSupabase() {
      try {
        // Load Supabase library
        if (!window.supabase) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
        
        // Create Supabase client with YOUR credentials
        supabase = window.supabase.createClient(
          'https://cpegnfupiqdgmqsguyed.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwZWduZnVwaXFkZ21xc2d1eWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI4NTA5ODMsImV4cCI6MjA0ODQyNjk4M30.zHRNKkZ5Lly4q4fRZQzT5iWTtq67j3JNkaf3-_W8BkI'
        );
        
        // Test connection
        const { data, error } = await supabase.from('words').select('text').limit(1);
        
        if (error) {
          console.error('Supabase connection error:', error);
          document.getElementById('connectionStatus').innerHTML = 'âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
          document.getElementById('connectionStatus').className = 'connection-status disconnected';
        } else {
          console.log('âœ… Connected to Supabase! Words available:', data.length);
          document.getElementById('connectionStatus').innerHTML = 'âœ… Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø¬Ø§Ù‡Ø²';
          document.getElementById('connectionStatus').className = 'connection-status connected';
        }
        
        // Setup tables if needed
        await setupTables();
        
      } catch (error) {
        console.error('Init error:', error);
        document.getElementById('connectionStatus').innerHTML = 'âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
      }
    }
    
    // ========== TABLE SETUP ==========
    async function setupTables() {
      try {
        // Try to create tables if they don't exist
        const { error } = await supabase.from('rooms').select('*').limit(1);
        
        if (error && error.message.includes('does not exist')) {
          console.log('Tables need to be created');
          // You'll need to run the SQL in Supabase SQL Editor
          alert('ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ Supabase SQL Editor');
        }
      } catch (error) {
        console.error('Table setup error:', error);
      }
    }
    
    // ========== UI FUNCTIONS ==========
    function showCreate() {
      hideAll();
      document.getElementById('create').classList.remove('hide');
      document.getElementById('createErr').textContent = '';
    }
    
    function showJoin() {
      hideAll();
      document.getElementById('join').classList.remove('hide');
      document.getElementById('roomCodeInput').focus();
      document.getElementById('joinErr').textContent = '';
    }
    
    function goBack() {
      clearInterval(pollInterval);
      hideAll();
      document.getElementById('menu').classList.remove('hide');
    }
    
    function hideAll() {
      ['menu','create','join','lobby','waiting','game'].forEach(id => {
        document.getElementById(id).classList.add('hide');
      });
    }
    
    // ========== CREATE ROOM ==========
    async function createRoom() {
      const errorElement = document.getElementById('createErr');
      errorElement.textContent = '';
      
      try {
        // Generate unique room code
        roomCode = Math.floor(1000 + Math.random() * 9000).toString();
        playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        playerNumber = 1;
        isHost = true;
        
        console.log('Creating room:', roomCode);
        
        // First check if room already exists
        const { data: existingRoom } = await supabase
          .from('rooms')
          .select('code')
          .eq('code', roomCode)
          .maybeSingle();
          
        if (existingRoom) {
          errorElement.textContent = 'Ø§Ù„Ø±Ù…Ø² Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
          return;
        }
        
        // Create room in Supabase
        const { error: roomError } = await supabase.from('rooms').insert([
          {
            code: roomCode,
            status: 'open',
            state: 'waiting',
            host_player_id: playerId,
            created_at: new Date().toISOString()
          }
        ]);
        
        if (roomError) {
          console.error('Room creation error:', roomError);
          errorElement.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: ' + roomError.message;
          return;
        }
        
        // Add host as player 1
        const { error: playerError } = await supabase.from('players').insert([
          {
            room_code: roomCode,
            player_id: playerId,
            player_num: 1,
            joined_at: new Date().toISOString()
          }
        ]);
        
        if (playerError) {
          console.error('Player creation error:', playerError);
          errorElement.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨: ' + playerError.message;
          return;
        }
        
        // Save to localStorage
        localStorage.setItem('imposter_room', JSON.stringify({
          code: roomCode,
          playerId: playerId,
          playerNumber: playerNumber,
          isHost: isHost
        }));
        
        // Show lobby
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        hideAll();
        document.getElementById('lobby').classList.remove('hide');
        
        // Start polling for players
        startPolling();
        
        console.log('âœ… Room created successfully! Code:', roomCode);
        
      } catch (error) {
        console.error('Create room error:', error);
        errorElement.textContent = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + error.message;
      }
    }
    
    // ========== JOIN ROOM ==========
    async function joinRoom() {
      const errorElement = document.getElementById('joinErr');
      errorElement.textContent = '';
      
      try {
        const inputCode = document.getElementById('roomCodeInput').value.trim();
        
        if (!/^\d{4}$/.test(inputCode)) {
          errorElement.textContent = 'Ø£Ø¯Ø®Ù„ 4 Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø©';
          return;
        }
        
        roomCode = inputCode;
        playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        isHost = false;
        
        console.log('Joining room:', roomCode);
        
        // Check if room exists and is open
        const { data: room, error: roomError } = await supabase
          .from('rooms')
          .select('*')
          .eq('code', roomCode)
          .eq('status', 'open')
          .maybeSingle();
          
        if (roomError) {
          console.error('Room check error:', roomError);
          errorElement.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + roomError.message;
          return;
        }
        
        if (!room) {
          errorElement.textContent = 'âŒ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ù…ØºÙ„Ù‚Ø©';
          return;
        }
        
        // Get current players to determine player number
        const { data: players, error: playersError } = await supabase
          .from('players')
          .select('player_num')
          .eq('room_code', roomCode);
          
        if (playersError) {
          console.error('Players check error:', playersError);
          errorElement.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: ' + playersError.message;
          return;
        }
        
        // Find next available player number
        const usedNumbers = players ? players.map(p => p.player_num) : [];
        let nextNumber = 1;
        while (usedNumbers.includes(nextNumber)) nextNumber++;
        
        playerNumber = nextNumber;
        
        // Add player to room
        const { error: addError } = await supabase.from('players').insert([
          {
            room_code: roomCode,
            player_id: playerId,
            player_num: playerNumber,
            joined_at: new Date().toISOString()
          }
        ]);
        
        if (addError) {
          console.error('Add player error:', addError);
          errorElement.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ' + addError.message;
          return;
        }
        
        // Save to localStorage
        localStorage.setItem('imposter_room', JSON.stringify({
          code: roomCode,
          playerId: playerId,
          playerNumber: playerNumber,
          isHost: isHost
        }));
        
        // Show waiting screen
        document.getElementById('playerTitle').textContent = `Ù„Ø§Ø¹Ø¨ ${playerNumber}`;
        hideAll();
        document.getElementById('waiting').classList.remove('hide');
        
        // Start polling for game updates
        startPolling();
        
        console.log('âœ… Joined room successfully! Player:', playerNumber);
        
      } catch (error) {
        console.error('Join room error:', error);
        errorElement.textContent = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + error.message;
      }
    }
    
    // ========== POLLING SYSTEM ==========
    function startPolling() {
      if (pollInterval) clearInterval(pollInterval);
      
      pollInterval = setInterval(async () => {
        try {
          if (!roomCode) return;
          
          // Get room status
          const { data: room, error: roomError } = await supabase
            .from('rooms')
            .select('*')
            .eq('code', roomCode)
            .maybeSingle();
            
          if (roomError) throw roomError;
          
          if (!room || room.status !== 'open') {
            clearInterval(pollInterval);
            alert('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©');
            localStorage.removeItem('imposter_room');
            goBack();
            return;
          }
          
          // Get players in room
          const { data: players, error: playersError } = await supabase
            .from('players')
            .select('player_id, player_num')
            .eq('room_code', roomCode)
            .order('player_num');
            
          if (playersError) throw playersError;
          
          // Update display based on role and state
          if (isHost && room.state === 'waiting') {
            updateLobby(players);
          } else if (!isHost && room.state === 'waiting') {
            updateWaiting(players);
          }
          
          if (room.state === 'playing') {
            showGame(room);
          }
          
        } catch (error) {
          console.error('Polling error:', error);
        }
      }, 2000); // Poll every 2 seconds
    }
    
    function updateLobby(players) {
      if (!players) return;
      
      let playersHtml = '';
      players.forEach(player => {
        playersHtml += `<div class="player">
          Ù„Ø§Ø¹Ø¨ ${player.player_num} 
          ${player.player_id === playerId ? '<strong>(Ø£Ù†Øª - Ø§Ù„Ù…Ø¶ÙŠÙ)</strong>' : ''}
        </div>`;
      });
      
      document.getElementById('playersList').innerHTML = playersHtml;
    }
    
    function updateWaiting(players) {
      if (!players) return;
      document.getElementById('playerCount').textContent = `Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: ${players.length}`;
    }
    
    // ========== GAME FUNCTIONS ==========
    async function startGame() {
      try {
        // Get all players
        const { data: players, error: playersError } = await supabase
          .from('players')
          .select('player_id')
          .eq('room_code', roomCode);
          
        if (playersError) throw playersError;
        
        if (!players || players.length < 2) {
          alert('ÙŠØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 2');
          return;
        }
        
        // Get random word from YOUR Arabic words
        const { data: words, error: wordsError } = await supabase
          .from('words')
          .select('text');
          
        if (wordsError) throw wordsError;
        if (!words || words.length === 0) {
          alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          return;
        }
        
        const randomWord = words[Math.floor(Math.random() * words.length)].text;
        
        // Select imposters
        const playerCount = players.length;
        const imposterCount = playerCount >= 5 ? 2 : 1;
        const shuffled = [...players].sort(() => Math.random() - 0.5);
        const imposters = shuffled.slice(0, imposterCount).map(p => p.player_id);
        
        // Update room to playing state
        const { error: updateError } = await supabase
          .from('rooms')
          .update({
            state: 'playing',
            word: randomWord,
            spy_player_id: imposters[0],
            imposters: imposters,
            started_at: new Date().toISOString()
          })
          .eq('code', roomCode);
          
        if (updateError) throw updateError;
        
        console.log('âœ… Game started! Word:', randomWord, 'Imposters:', imposters);
        
      } catch (error) {
        console.error('Start game error:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©: ' + error.message);
      }
    }
    
    async function showGame(room) {
      if (!room || room.state !== 'playing') return;
      
      hideAll();
      document.getElementById('game').classList.remove('hide');
      
      document.getElementById('gamePlayerTitle').textContent = `Ù„Ø§Ø¹Ø¨ ${playerNumber}`;
      
      const isImposter = room.imposters && room.imposters.includes(playerId);
      const roleBox = document.getElementById('roleBox');
      
      if (isImposter) {
        roleBox.className = 'roleBox spy';
        roleBox.innerHTML = 'ğŸ•µï¸<br><br><strong>Ø£Ù†Øª Ø§Ù„Ù…Ø®Ø¨Ø±!</strong><br><br>Ø­Ø§ÙˆÙ„ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙƒÙ„Ù…Ø©';
      } else {
        roleBox.className = 'roleBox';
        roleBox.innerHTML = `Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©:<br><div class="word">${room.word || '...'}</div>`;
      }
      
      if (isHost) {
        document.getElementById('hostControls').classList.remove('hide');
      }
    }
    
    async function leaveRoom() {
      try {
        // Remove player from database
        await supabase
          .from('players')
          .delete()
          .eq('player_id', playerId);
        
        // If host, close the room
        if (isHost) {
          await supabase
            .from('rooms')
            .update({ status: 'closed' })
            .eq('code', roomCode);
        }
        
        // Clear localStorage
        localStorage.removeItem('imposter_room');
        
        clearInterval(pollInterval);
        goBack();
        
      } catch (error) {
        console.error('Leave room error:', error);
      }
    }
    
    async function endGame() {
      try {
        await supabase
          .from('rooms')
          .update({ state: 'ended' })
          .eq('code', roomCode);
          
        alert('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©');
        
      } catch (error) {
        console.error('End game error:', error);
      }
    }
    
    async function newGame() {
      try {
        await supabase
          .from('rooms')
          .update({
            state: 'waiting',
            word: null,
            spy_player_id: null,
            imposters: null,
            started_at: null
          })
          .eq('code', roomCode);
          
        hideAll();
        document.getElementById('lobby').classList.remove('hide');
        
      } catch (error) {
        console.error('New game error:', error);
      }
    }
    
    // ========== INITIALIZATION ==========
    async function init() {
      await initSupabase();
      
      // Restore previous session
      const saved = localStorage.getItem('imposter_room');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          roomCode = data.code;
          playerId = data.playerId;
          playerNumber = data.playerNumber;
          isHost = data.isHost;
          
          if (isHost) {
            document.getElementById('roomCodeDisplay').textContent = roomCode;
            hideAll();
            document.getElementById('lobby').classList.remove('hide');
          } else {
            document.getElementById('playerTitle').textContent = `Ù„Ø§Ø¹Ø¨ ${playerNumber}`;
            hideAll();
            document.getElementById('waiting').classList.remove('hide');
          }
          
          startPolling();
          
        } catch (error) {
          console.error('Restore session error:', error);
          localStorage.removeItem('imposter_room');
        }
      }
    }
    
    // Start everything
    init();
  </script>
</body>
</html>
