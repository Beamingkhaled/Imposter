<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin V2</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      background: #1e3a8a;
      min-height:100vh;
      padding:20px;
    }
    .container{
      background:#fff;
      border-radius:20px;
      padding:28px;
      max-width:520px;
      margin:0 auto;
    }
    h1{ text-align:center; color:#1e3a8a; margin-bottom:20px; }
    input, button{ width:100%; padding:15px; margin:10px 0; font-size:16px; border-radius:8px; border:2px solid #ccc; }
    button{ background:#1e3a8a; color:#fff; border:none; cursor:pointer; font-weight:bold; }
    button:hover{ background:#1e40af; }
    .hide{ display:none; }
    .code{ font-size:60px; text-align:center; font-weight:900; color:#1e3a8a; margin:20px 0; }
    .error{ color:red; font-weight:bold; margin:10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ADMIN V2 (BLUE)</h1>

    <!-- LOGIN -->
    <div id="login">
      <input id="pw" type="text" value="admin123" placeholder="Password">
      <button onclick="login()">LOGIN</button>
      <div id="err1" class="error"></div>
    </div>

    <!-- SETUP -->
    <div id="setup" class="hide">
      <h2>Create Room</h2>
      <input id="codeBox" type="text" readonly>
      <button onclick="makeRoom()">GENERATE ROOM CODE</button>
      <div id="err2" class="error"></div>
    </div>

    <!-- CONTROL -->
    <div id="control" class="hide">
      <h2>Room Code:</h2>
      <div class="code" id="bigCode">0000</div>
      <p>Players: <span id="pCount">0</span></p>
      <div id="pList"></div>
      <button onclick="startGame()">START GAME</button>
      <button onclick="resetGame()">RESET</button>
      <button onclick="closeIt()">CLOSE ROOM</button>
      <div id="err3" class="error"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const sb = window.supabase.createClient(
      "https://cpegnfupiqdgmqsguyed.supabase.co",
      "sb_publishable_WKaLUCc9WeXbEcgDfMf1KQ_NKYoTVuU"
    );

    let code = null;
    let timer = null;

    function login() {
      const p = document.getElementById("pw").value;
      if (p !== "admin123") {
        document.getElementById("err1").textContent = "Wrong password";
        return;
      }
      document.getElementById("login").className = "hide";
      document.getElementById("setup").className = "";
    }

    async function makeRoom() {
      document.getElementById("err2").textContent = "";
      try {
        code = String(Math.floor(1000 + Math.random() * 9000));
        document.getElementById("codeBox").value = code;

        const { error } = await sb.from("rooms").insert([{ 
          code: code, 
          status: "open", 
          state: "waiting" 
        }]);

        if (error) throw error;

        document.getElementById("setup").className = "hide";
        document.getElementById("control").className = "";
        document.getElementById("bigCode").textContent = code;
        poll();

      } catch (e) {
        document.getElementById("err2").textContent = e.message;
      }
    }

    async function startGame() {
      document.getElementById("err3").textContent = "";
      try {
        const { data: players } = await sb.from("players")
          .select("player_id")
          .eq("room_code", code);

        if (!players || players.length < 3) {
          document.getElementById("err3").textContent = "Need 3+ players";
          return;
        }

        const { data: words } = await sb.from("words").select("text");
        if (!words || words.length === 0) throw new Error("No words in database");

        const word = words[Math.floor(Math.random() * words.length)].text;
        const spy = players[Math.floor(Math.random() * players.length)].player_id;

        await sb.from("rooms").update({
          state: "playing",
          word: word,
          spy_player_id: spy,
          started_at: new Date().toISOString()
        }).eq("code", code);

      } catch (e) {
        document.getElementById("err3").textContent = e.message;
      }
    }

    async function resetGame() {
      if (!confirm("Reset?")) return;
      await sb.from("rooms").update({
        state: "waiting",
        word: null,
        spy_player_id: null,
        started_at: null
      }).eq("code", code);
    }

    async function closeIt() {
      if (!confirm("Close room?")) return;
      await sb.from("rooms").update({ status: "closed" }).eq("code", code);
      await sb.from("players").delete().eq("room_code", code);
      if (timer) clearInterval(timer);
      location.reload();
    }

    async function poll() {
      if (timer) clearInterval(timer);
      timer = setInterval(async () => {
        const { data: players } = await sb.from("players")
          .select("player_num")
          .eq("room_code", code);

        if (players) {
          document.getElementById("pCount").textContent = players.length;
          document.getElementById("pList").innerHTML = players
            .map(p => `<div>Player ${p.player_num}</div>`)
            .join("");
        }
      }, 2000);
    }
  </script>
</body>
</html>
