<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ğŸ‘‘</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
      min-height:100vh;padding:20px;
    }
    .container{
      background:#fff;border-radius:20px;padding:28px;max-width:520px;margin:0 auto;
      box-shadow:0 10px 40px rgba(0,0,0,.25);
    }
    h1{text-align:center;color:#f5576c;margin-bottom:22px}
    label{display:block;margin:12px 0 8px;font-weight:700;color:#333}
    input{
      width:100%;padding:12px;border:2px solid #ddd;border-radius:10px;font-size:18px;
      text-align:center
    }
    button{
      width:100%;padding:14px;margin-top:12px;border:0;border-radius:12px;
      background:#f5576c;color:#fff;font-size:18px;font-weight:800;cursor:pointer
    }
    button:hover{opacity:.92}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:10px}
    .row button{width:50%}
    .btn-success{background:#28a745}
    .btn-secondary{background:#6c757d}
    .card{
      margin-top:16px;background:#f8f9fa;border-radius:14px;padding:14px;border:2px solid #eee
    }
    .room-code{
      font-size:52px;font-weight:900;text-align:center;color:#f5576c;margin:10px 0 6px
    }
    .status{
      text-align:center;padding:10px;border-radius:10px;font-weight:800;margin-top:10px
    }
    .waiting{background:#fff3cd;color:#856404}
    .playing{background:#d4edda;color:#155724}
    .players{margin-top:10px}
    .player-item{
      background:#fff;border:2px solid #eee;border-radius:10px;padding:10px;margin-top:8px;font-weight:800
    }
    .hidden{display:none}
    .hint{color:#666;font-size:13px;margin-top:8px;line-height:1.5;text-align:center}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>

    <div id="loginScreen">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input id="adminPassword" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
      <div class="hint">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‡Ù†Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (Ù„Ù„Ù€ MVP). Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù†Ø£Ù…Ù†Ù‡Ø§ Ø¨Ù€ RLS.</div>
    </div>

    <div id="setupScreen" class="hidden">
      <label>Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© (Ù¤ Ø£Ø±Ù‚Ø§Ù…)</label>
      <input id="roomCodeInput" type="tel" inputmode="numeric" maxlength="4" placeholder="Ù…Ø«Ø§Ù„: 1234">
      <button id="createRoomBtn">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
      <div class="hint">Ù†ØµÙŠØ­Ø©: Ø§Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯ Ù„ÙƒÙ„ Ø¬Ù„Ø³Ø© Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØµÙŠØ± ØªØ¶Ø§Ø±Ø¨.</div>
    </div>

    <div id="controlScreen" class="hidden">
      <div class="card">
        <div style="text-align:center;color:#666;font-weight:700;">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</div>
        <div class="room-code" id="roomCodeDisplay">----</div>
        <div id="statusBox" class="status waiting">â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</div>

        <div class="players">
          <div style="font-weight:900;margin-top:12px;">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (<span id="playerCount">0</span>)</div>
          <div id="playersList"></div>
        </div>
      </div>

      <button class="btn-success" id="startRoundBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
      <div class="row">
        <button class="btn-secondary" id="resetRoundBtn">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <button id="closeRoomBtn">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // âœ… YOUR SUPABASE CONFIG
    const SUPABASE_URL = "https://cpegnfupiqdgmqsguyed.supabase.co";
    const SUPABASE_KEY = "sb_publishable_WKaLUCc9WeXbEcgDfMf1KQ_NKYoTVuU";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ğŸ” MVP password (change it)
    const ADMIN_PASSWORD = "admin123";

    let roomCode = "";
    let pollTimer = null;

    const $ = (id) => document.getElementById(id);

    $("loginBtn").addEventListener("click", () => {
      const pw = $("adminPassword").value.trim();
      if (pw !== ADMIN_PASSWORD) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©");
      $("loginScreen").classList.add("hidden");
      $("setupScreen").classList.remove("hidden");
    });

    $("createRoomBtn").addEventListener("click", createRoom);
    $("startRoundBtn").addEventListener("click", startRound);
    $("resetRoundBtn").addEventListener("click", resetRound);
    $("closeRoomBtn").addEventListener("click", closeRoom);

    function isValid4DigitCode(code){
      return /^\d{4}$/.test(code);
    }

    async function createRoom(){
      const code = $("roomCodeInput").value.trim();
      if (!isValid4DigitCode(code)) return alert("Ø§ÙƒØªØ¨ Ø±Ù…Ø² Ù¤ Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·");

      roomCode = code;

      // Create room
      const { error } = await supabase
        .from("rooms")
        .insert([{ code: roomCode }]);

      if (error) {
        if ((error.message || "").toLowerCase().includes("duplicate") || (error.code === "23505")) {
          return alert("Ø§Ù„Ø±Ù…Ø² Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø«Ø§Ù†ÙŠ.");
        }
        console.error(error);
        return alert("ØµØ§Ø± Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©");
      }

      $("setupScreen").classList.add("hidden");
      $("controlScreen").classList.remove("hidden");
      $("roomCodeDisplay").textContent = roomCode;

      startPolling();
    }

    async function startRound(){
      $("startRoundBtn").disabled = true;

      // Get players
      const { data: players, error: pErr } = await supabase
        .from("players")
        .select("player_uid, player_num")
        .eq("room_code", roomCode)
        .order("player_num", { ascending: true });

      if (pErr) {
        console.error(pErr);
        $("startRoundBtn").disabled = false;
        return alert("Ù…Ø§ Ù‚Ø¯Ø±Øª Ø£Ø¬ÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†");
      }

      if (!players || players.length < 3) {
        $("startRoundBtn").disabled = false;
        return alert("Ù„Ø§Ø²Ù… Ù£ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
      }

      // Pick random word from DB using RPC
      const { data: wordRows, error: wErr } = await supabase.rpc("pick_random_word");
      if (wErr || !wordRows || !wordRows[0]) {
        console.error(wErr);
        $("startRoundBtn").disabled = false;
        return alert("ÙØ´Ù„ Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ„Ù…Ø©. ØªØ£ÙƒØ¯ Ø¥Ù† Function Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØ£Ù† Ø¬Ø¯ÙˆÙ„ words ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª");
      }
      const word = wordRows[0]; // {id, text}

      // Pick spy
      const spy = players[Math.floor(Math.random() * players.length)];

      // Update room state
      const { error: uErr } = await supabase
        .from("rooms")
        .update({
          state: "playing",
          word_id: word.id,
          spy_player_uid: spy.player_uid,
          round_started_at: new Date().toISOString()
        })
        .eq("code", roomCode);

      if (uErr) {
        console.error(uErr);
        $("startRoundBtn").disabled = false;
        return alert("ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©");
      }

      setStatus("ğŸ® Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„", true);
      // keep disabled while playing; polling will update too
    }

    async function resetRound(){
      if (!confirm("Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ")) return;

      const { error } = await supabase
        .from("rooms")
        .update({
          state: "waiting",
          word_id: null,
          spy_player_uid: null,
          round_started_at: null
        })
        .eq("code", roomCode);

      if (error) {
        console.error(error);
        return alert("ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·");
      }

      setStatus("â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡...", false);
      $("startRoundBtn").disabled = false;
    }

    async function closeRoom(){
      if (!confirm("Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©ØŸ")) return;

      // deleting room will cascade delete players due to FK
      const { error } = await supabase
        .from("rooms")
        .delete()
        .eq("code", roomCode);

      if (error) {
        console.error(error);
        return alert("ÙØ´Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©");
      }
      location.reload();
    }

    function setStatus(text, playing){
      const box = $("statusBox");
      box.textContent = text;
      box.className = "status " + (playing ? "playing" : "waiting");
    }

    function toArabicDigits(num){
      const ar = ['Ù ','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©'];
      return String(num).split('').map(d => ar[parseInt(d,10)] ?? d).join('');
    }

    function startPolling(){
      if (pollTimer) clearInterval(pollTimer);

      pollTimer = setInterval(async () => {
        // room state
        const { data: room, error: rErr } = await supabase
          .from("rooms")
          .select("state")
          .eq("code", roomCode)
          .single();

        if (!rErr && room) {
          if (room.state === "playing") {
            setStatus("ğŸ® Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„", true);
            $("startRoundBtn").disabled = true;
          } else {
            setStatus("â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡...", false);
            $("startRoundBtn").disabled = false;
          }
        }

        // players list
        const { data: players, error: pErr } = await supabase
          .from("players")
          .select("player_num")
          .eq("room_code", roomCode)
          .order("player_num", { ascending: true });

        if (!pErr && players) {
          $("playerCount").textContent = players.length;
          $("playersList").innerHTML = players.map(p =>
            `<div class="player-item">Ù„Ø§Ø¹Ø¨ ${toArabicDigits(p.player_num)}</div>`
          ).join("");
        }
      }, 1200);
    }

    window.addEventListener("beforeunload", () => {
      if (pollTimer) clearInterval(pollTimer);
    });
  </script>
</body>
</html>
