<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <title>Admin Panel ðŸ‘‘</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      min-height:100vh;
      padding:20px;
    }
    .container{
      background:#fff;
      border-radius:20px;
      padding:28px;
      max-width:520px;
      margin:0 auto;
      box-shadow:0 10px 40px rgba(0,0,0,.25);
    }
    h1{
      text-align:center;
      margin-bottom:18px;
      color:#f5576c;
      font-size:28px;
    }
    .row{ margin:14px 0; }
    label{
      display:block;
      margin-bottom:8px;
      font-weight:700;
      color:#222;
    }
    input{
      width:100%;
      padding:12px 14px;
      border:2px solid #ddd;
      border-radius:10px;
      font-size:16px;
    }
    button{
      width:100%;
      padding:14px 16px;
      border:none;
      border-radius:12px;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
      margin-top:10px;
      color:#fff;
      background:#f5576c;
    }
    button:hover{ background:#e04858; }
    .btn-success{ background:#28a745; }
    .btn-success:hover{ background:#218838; }
    .btn-secondary{ background:#6c757d; }
    .btn-secondary:hover{ background:#5a6268; }

    .hidden{ display:none; }

    .card{
      background:#f7f7fb;
      border:1px solid #ececf3;
      padding:14px;
      border-radius:14px;
      margin-top:14px;
    }
    .code{
      text-align:center;
      font-size:54px;
      letter-spacing:3px;
      font-weight:900;
      color:#f5576c;
      margin:10px 0 4px;
    }
    .status{
      text-align:center;
      font-weight:800;
      padding:10px;
      border-radius:12px;
      margin-top:10px;
    }
    .waiting{ background:#fff3cd; color:#856404; }
    .playing{ background:#d4edda; color:#155724; }

    .players{
      margin-top:10px;
    }
    .player{
      background:#fff;
      border:1px solid #e9e9f2;
      border-radius:10px;
      padding:10px 12px;
      margin:8px 0;
      font-weight:800;
    }
    .small{
      font-size:12px;
      color:#666;
      margin-top:10px;
      text-align:center;
    }
    .error{
      color:#b00020;
      font-weight:700;
      margin-top:10px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ðŸ‘‘ Admin Panel</h1>

    <div id="loginScreen">
      <div class="row">
        <label>Admin Password</label>
        <input id="adminPass" type="password" placeholder="Enter password" />
      </div>
      <button id="loginBtn">Login</button>
      <div class="small">Password: admin123</div>
      <div id="loginError" class="error"></div>
    </div>

    <div id="setupScreen" class="hidden">
      <div class="card">
        <div class="row">
          <label>Room Code</label>
          <input id="roomCodeInput" type="tel" placeholder="Auto-generated (4 digits)" readonly />
        </div>
        <button id="createRoomBtn" class="btn-success">Create Room (Generate 4 digits)</button>
        <div id="setupErr" class="error"></div>
      </div>
    </div>

    <div id="controlScreen" class="hidden">
      <div class="card">
        <div class="small">ROOM CODE</div>
        <div class="code" id="roomCodeBig">0000</div>

        <div id="statusBox" class="status waiting">Waiting for playersâ€¦</div>

        <div class="players">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
            <div style="font-weight:900;">Players</div>
            <div style="font-weight:900;">(<span id="playerCount">0</span>)</div>
          </div>
          <div id="playersList"></div>
        </div>

        <button id="startBtn" class="btn-success">Start Round</button>
        <button id="resetBtn" class="btn-secondary">New Round (Reset)</button>
        <button id="closeBtn">Close Room</button>

        <div id="controlErr" class="error"></div>
      </div>

      <div class="small">If your changes "don't show", hard refresh: iPad Safari/Brave â†’ reload icon or clear cache.</div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ======== SUPABASE CONFIG ========
    const SUPABASE_URL = "https://cpegnfupiqdgmqsguyed.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_WKaLUCc9WeXbEcgDfMf1KQ_NKYoTVuU";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ======== ADMIN PASSWORD ========
    const ADMIN_PASSWORD = "admin123";

    // ======== STATE ========
    let roomCode = null;
    let pollTimer = null;

    // ======== UI ========
    const loginScreen = document.getElementById("loginScreen");
    const setupScreen = document.getElementById("setupScreen");
    const controlScreen = document.getElementById("controlScreen");

    const loginError = document.getElementById("loginError");
    const setupErr = document.getElementById("setupErr");
    const controlErr = document.getElementById("controlErr");

    const roomCodeInput = document.getElementById("roomCodeInput");
    const roomCodeBig = document.getElementById("roomCodeBig");

    const statusBox = document.getElementById("statusBox");
    const playersList = document.getElementById("playersList");
    const playerCount = document.getElementById("playerCount");

    document.getElementById("loginBtn").addEventListener("click", () => {
      loginError.textContent = "";
      const pass = document.getElementById("adminPass").value;
      console.log("Entered password:", pass);
      console.log("Expected password:", ADMIN_PASSWORD);
      
      if (pass !== ADMIN_PASSWORD) {
        loginError.textContent = "Wrong password. Try: admin123";
        return;
      }
      
      loginScreen.classList.add("hidden");
      setupScreen.classList.remove("hidden");
    });

    document.getElementById("createRoomBtn").addEventListener("click", async () => {
      setupErr.textContent = "";
      try {
        console.log("Creating room...");
        console.log("Supabase URL:", SUPABASE_URL);
        console.log("Supabase Key:", SUPABASE_ANON_KEY);
        
        roomCode = await generateUnique4DigitCode();
        roomCodeInput.value = roomCode;

        // create room row
        const { error } = await supabase
          .from("rooms")
          .insert([{ code: roomCode, status: "open", state: "waiting" }]);

        if (error) {
          console.error("Supabase error:", error);
          throw error;
        }

        // show control
        setupScreen.classList.add("hidden");
        controlScreen.classList.remove("hidden");
        roomCodeBig.textContent = roomCode;

        startPolling();

      } catch (e) {
        console.error("Full error:", e);
        setupErr.textContent = e?.message || "Failed creating room";
      }
    });

    document.getElementById("startBtn").addEventListener("click", async () => {
      controlErr.textContent = "";
      try {
        const players = await fetchPlayers();
        if (players.length < 3) {
          controlErr.textContent = "Need at least 3 players";
          return;
        }

        // fetch all words once, pick random client-side
        const { data: words, error: werr } = await supabase
          .from("words")
          .select("text");

        if (werr) throw werr;
        if (!words || words.length === 0) throw new Error("No words found in table 'words'");

        const randomWord = words[Math.floor(Math.random() * words.length)].text;

        const spy = players[Math.floor(Math.random() * players.length)].player_id;

        const { error } = await supabase
          .from("rooms")
          .update({
            state: "playing",
            word: randomWord,
            spy_player_id: spy,
            started_at: new Date().toISOString()
          })
          .eq("code", roomCode);

        if (error) throw error;

      } catch (e) {
        console.error(e);
        controlErr.textContent = e?.message || "Failed starting round";
      }
    });

    document.getElementById("resetBtn").addEventListener("click", async () => {
      if (!confirm("Reset the round?")) return;
      controlErr.textContent = "";
      try {
        const { error } = await supabase
          .from("rooms")
          .update({
            state: "waiting",
            word: null,
            spy_player_id: null,
            started_at: null
          })
          .eq("code", roomCode);

        if (error) throw error;

      } catch (e) {
        console.error(e);
        controlErr.textContent = e?.message || "Failed reset";
      }
    });

    document.getElementById("closeBtn").addEventListener("click", async () => {
      if (!confirm("Close this room?")) return;
      controlErr.textContent = "";
      try {
        await supabase.from("rooms").update({ status: "closed" }).eq("code", roomCode);
        // optional: remove players
        await supabase.from("players").delete().eq("room_code", roomCode);

        if (pollTimer) clearInterval(pollTimer);
        location.reload();

      } catch (e) {
        console.error(e);
        controlErr.textContent = e?.message || "Failed closing room";
      }
    });

    async function startPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async () => {
        try {
          const { data: room, error } = await supabase
            .from("rooms")
            .select("*")
            .eq("code", roomCode)
            .maybeSingle();

          if (error) throw error;
          if (!room) return;

          if (room.status === "closed") {
            statusBox.className = "status waiting";
            statusBox.textContent = "Room closed";
            return;
          }

          if (room.state === "playing") {
            statusBox.className = "status playing";
            statusBox.textContent = "Round is LIVE ðŸŽ®";
          } else {
            statusBox.className = "status waiting";
            statusBox.textContent = "Waiting for playersâ€¦";
          }

          const players = await fetchPlayers();
          playerCount.textContent = players.length.toString();
          playersList.innerHTML = players
            .map(p => `<div class="player">Player ${p.player_num}</div>`)
            .join("");

        } catch (e) {
          console.error("poll error", e);
        }
      }, 1500);
    }

    async function fetchPlayers() {
      const { data, error } = await supabase
        .from("players")
        .select("player_id, player_num, created_at")
        .eq("room_code", roomCode)
        .order("player_num", { ascending: true });

      if (error) throw error;
      return data || [];
    }

    async function generateUnique4DigitCode() {
      // Try multiple times to avoid collisions
      for (let i = 0; i < 50; i++) {
        const code = String(Math.floor(1000 + Math.random() * 9000));
        const { data, error } = await supabase
          .from("rooms")
          .select("code, status")
          .eq("code", code)
          .maybeSingle();

        if (error) throw error;
        if (!data) return code;            // unused
        if (data.status === "closed") return code; // reuse if closed
      }
      throw new Error("Could not generate unique room code. Try again.");
    }

    window.addEventListener("beforeunload", () => {
      if (pollTimer) clearInterval(pollTimer);
    });
  </script>
</body>
</html>
